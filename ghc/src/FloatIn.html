<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

************************************************************************
*                                                                      *
\section[FloatIn]{Floating Inwards pass}
*                                                                      *
************************************************************************

The main purpose of @floatInwards@ is floating into branches of a
case, so that we don't allocate things, save them on the stack, and
then discover that they aren't needed in the chosen branch.
-}</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">FloatIn</span><span> </span><span class="hs-special">(</span><span> </span><a href="FloatIn.html#floatInwards"><span class="hs-identifier hs-var">floatInwards</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="MkCore.html"><span class="hs-identifier">MkCore</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="CoreUtils.html"><span class="hs-identifier">CoreUtils</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="CoreUtils.html#exprIsDupable"><span class="hs-identifier hs-var">exprIsDupable</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#exprIsExpandable"><span class="hs-identifier hs-var">exprIsExpandable</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>                          </span><a href="CoreUtils.html#exprOkForSideEffects"><span class="hs-identifier hs-var">exprOkForSideEffects</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="CoreFVs.html"><span class="hs-identifier">CoreFVs</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>               </span><span class="hs-special">(</span><span> </span><a href="Id.html#isOneShotBndr"><span class="hs-identifier hs-var">isOneShotBndr</span></a><span class="hs-special">,</span><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>             </span><span class="hs-special">(</span><span> </span><a href="Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span class="hs-special">(</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-comment">{-
Top-level interface function, @floatInwards@.  Note that we do not
actually float any bindings downwards from the top-level.
-}</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-identifier">floatInwards</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span>
</span><a name="line-41"></a><a name="floatInwards"><a href="FloatIn.html#floatInwards"><span class="hs-identifier">floatInwards</span></a></a><span> </span><a name="local-1627953627"><a href="#local-1627953627"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1627953628"><span class="hs-identifier hs-var">fi_top_bind</span></a><span>
</span><a name="line-42"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-43"></a><span>    </span><a name="local-1627953628"><a href="#local-1627953628"><span class="hs-identifier">fi_top_bind</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-1627953629"><a href="#local-1627953629"><span class="hs-identifier">binder</span></a></a><span> </span><a name="local-1627953630"><a href="#local-1627953630"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-1627953629"><span class="hs-identifier hs-var">binder</span></a><span> </span><span class="hs-special">(</span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953627"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#freeVars"><span class="hs-identifier hs-var">freeVars</span></a><span> </span><a href="#local-1627953630"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>    </span><span class="hs-identifier">fi_top_bind</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-1627953631"><a href="#local-1627953631"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-1627953632"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953627"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#freeVars"><span class="hs-identifier hs-var">freeVars</span></a><span> </span><a href="#local-1627953633"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-1627953632"><a href="#local-1627953632"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953633"><a href="#local-1627953633"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627953631"><span class="hs-identifier hs-var">pairs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Mail from Andr\'e [edited]}
*                                                                      *
************************************************************************

{\em Will wrote: What??? I thought the idea was to float as far
inwards as possible, no matter what.  This is dropping all bindings
every time it sees a lambda of any kind.  Help! }

You are assuming we DO DO full laziness AFTER floating inwards!  We
have to [not float inside lambdas] if we don't.

If we indeed do full laziness after the floating inwards (we could
check the compilation flags for that) then I agree we could be more
aggressive and do float inwards past lambdas.

Actually we are not doing a proper full laziness (see below), which
was another reason for not floating inwards past a lambda.

This can easily be fixed.  The problem is that we float lets outwards,
but there are a few expressions which are not let bound, like case
scrutinees and case alternatives.  After floating inwards the
simplifier could decide to inline the let and the laziness would be
lost, e.g.

\begin{verbatim}
let a = expensive             ==&gt; \b -&gt; case expensive of ...
in \ b -&gt; case a of ...
\end{verbatim}
The fix is
\begin{enumerate}
\item
to let bind the algebraic case scrutinees (done, I think) and
the case alternatives (except the ones with an
unboxed type)(not done, I think). This is best done in the
SetLevels.hs module, which tags things with their level numbers.
\item
do the full laziness pass (floating lets outwards).
\item
simplify. The simplifier inlines the (trivial) lets that were
 created but were not floated outwards.
\end{enumerate}

With the fix I think Will's suggestion that we can gain even more from
strictness by floating inwards past lambdas makes sense.

We still gain even without going past lambdas, as things may be
strict in the (new) context of a branch (where it was floated to) or
of a let rhs, e.g.
\begin{verbatim}
let a = something            case x of
in case x of                   alt1 -&gt; case something of a -&gt; a + a
     alt1 -&gt; a + a      ==&gt;    alt2 -&gt; b
     alt2 -&gt; b

let a = something           let b = case something of a -&gt; a + a
in let b = a + a        ==&gt; in (b,b)
in (b,b)
\end{verbatim}
Also, even if a is not found to be strict in the new context and is
still left as a let, if the branch is not taken (or b is not entered)
the closure for a is not built.

************************************************************************
*                                                                      *
\subsection{Main floating-inwards code}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-keyword">type</span><span> </span><a name="FreeVarSet"><a href="FloatIn.html#FreeVarSet"><span class="hs-identifier">FreeVarSet</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#DIdSet"><span class="hs-identifier hs-type">DIdSet</span></a><span>
</span><a name="line-121"></a><span class="hs-keyword">type</span><span> </span><a name="BoundVarSet"><a href="FloatIn.html#BoundVarSet"><span class="hs-identifier">BoundVarSet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#DIdSet"><span class="hs-identifier hs-type">DIdSet</span></a><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-keyword">data</span><span> </span><a name="FloatInBind"><a href="FloatIn.html#FloatInBind"><span class="hs-identifier">FloatInBind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FB"><a href="FloatIn.html#FB"><span class="hs-identifier">FB</span></a></a><span> </span><a href="FloatIn.html#BoundVarSet"><span class="hs-identifier hs-type">BoundVarSet</span></a><span> </span><a href="FloatIn.html#FreeVarSet"><span class="hs-identifier hs-type">FreeVarSet</span></a><span> </span><a href="MkCore.html#FloatBind"><span class="hs-identifier hs-type">FloatBind</span></a><span>
</span><a name="line-124"></a><span>        </span><span class="hs-comment">-- The FreeVarSet is the free variables of the binding.  In the case</span><span>
</span><a name="line-125"></a><span>        </span><span class="hs-comment">-- of recursive bindings, the set doesn't include the bound</span><span>
</span><a name="line-126"></a><span>        </span><span class="hs-comment">-- variables.</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-keyword">type</span><span> </span><a name="FloatInBinds"><a href="FloatIn.html#FloatInBinds"><span class="hs-identifier">FloatInBinds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="FloatIn.html#FloatInBind"><span class="hs-identifier hs-type">FloatInBind</span></a><span class="hs-special">]</span><span>
</span><a name="line-129"></a><span>        </span><span class="hs-comment">-- In reverse dependency order (innermost binder first)</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-identifier">fiExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-132"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FloatIn.html#FloatInBinds"><span class="hs-identifier hs-type">FloatInBinds</span></a><span>      </span><span class="hs-comment">-- Binds we're trying to drop</span><span>
</span><a name="line-133"></a><span>                            </span><span class="hs-comment">-- as far &quot;inwards&quot; as possible</span><span>
</span><a name="line-134"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreFVs.html#CoreExprWithFVs"><span class="hs-identifier hs-type">CoreExprWithFVs</span></a><span>   </span><span class="hs-comment">-- Input expr</span><span>
</span><a name="line-135"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>          </span><span class="hs-comment">-- Result</span><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><a name="fiExpr"><a href="FloatIn.html#fiExpr"><span class="hs-identifier">fiExpr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627953634"><a href="#local-1627953634"><span class="hs-identifier">to_drop</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnLit"><span class="hs-identifier hs-var">AnnLit</span></a><span> </span><a name="local-1627953635"><a href="#local-1627953635"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-identifier">to_drop</span><span> </span><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a href="#local-1627953634"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-138"></a><span class="hs-identifier">fiExpr</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627953636"><a href="#local-1627953636"><span class="hs-identifier">to_drop</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnType"><span class="hs-identifier hs-var">AnnType</span></a><span> </span><a name="local-1627953637"><a href="#local-1627953637"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-identifier">to_drop</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">Type</span><span> </span><a href="#local-1627953636"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-139"></a><span class="hs-identifier">fiExpr</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627953638"><a href="#local-1627953638"><span class="hs-identifier">to_drop</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnVar"><span class="hs-identifier hs-var">AnnVar</span></a><span> </span><a name="local-1627953639"><a href="#local-1627953639"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-1627953638"><span class="hs-identifier hs-var">to_drop</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-1627953639"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span class="hs-identifier">fiExpr</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627953640"><a href="#local-1627953640"><span class="hs-identifier">to_drop</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnCoercion"><span class="hs-identifier hs-var">AnnCoercion</span></a><span> </span><a name="local-1627953641"><a href="#local-1627953641"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-1627953640"><span class="hs-identifier hs-var">to_drop</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a href="#local-1627953641"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span class="hs-identifier">fiExpr</span><span> </span><a name="local-1627953642"><a href="#local-1627953642"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1627953643"><a href="#local-1627953643"><span class="hs-identifier">to_drop</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnCast"><span class="hs-identifier hs-var">AnnCast</span></a><span> </span><a name="local-1627953644"><a href="#local-1627953644"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627953645"><a href="#local-1627953645"><span class="hs-identifier">co_ann</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953646"><a href="#local-1627953646"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627953647"><span class="hs-identifier hs-var">drop_here</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1627953649"><span class="hs-identifier hs-var">co_drop</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-143"></a><span>    </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><span class="hs-special">(</span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953642"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953648"><span class="hs-identifier hs-var">e_drop</span></a><span> </span><a href="#local-1627953644"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627953646"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-144"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-145"></a><span>    </span><span class="hs-special">[</span><a name="local-1627953647"><a href="#local-1627953647"><span class="hs-identifier">drop_here</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953648"><a href="#local-1627953648"><span class="hs-identifier">e_drop</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953649"><a href="#local-1627953649"><span class="hs-identifier">co_drop</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-146"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#sepBindsByDropPoint"><span class="hs-identifier hs-var">sepBindsByDropPoint</span></a><span> </span><a href="#local-1627953642"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-147"></a><span>          </span><span class="hs-special">[</span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953644"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">,</span><span> </span><a href="CoreFVs.html#freeVarsOfAnn"><span class="hs-identifier hs-var">freeVarsOfAnn</span></a><span> </span><a href="#local-1627953645"><span class="hs-identifier hs-var">co_ann</span></a><span class="hs-special">]</span><span>
</span><a name="line-148"></a><span>          </span><span class="hs-special">(</span><a href="CoreFVs.html#freeVarsOfType"><span class="hs-identifier hs-var">freeVarsOfType</span></a><span> </span><a href="#local-1627953644"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="CoreFVs.html#freeVarsOfTypeAnn"><span class="hs-identifier hs-var">freeVarsOfTypeAnn</span></a><span> </span><a href="#local-1627953645"><span class="hs-identifier hs-var">co_ann</span></a><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>          </span><a href="#local-1627953643"><span class="hs-identifier hs-var">to_drop</span></a><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-comment">{-
Applications: we do float inside applications, mainly because we
need to get at all the arguments.  The next simplifier run will
pull out any silly ones.
-}</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-identifier">fiExpr</span><span> </span><a name="local-1627953650"><a href="#local-1627953650"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1627953651"><a href="#local-1627953651"><span class="hs-identifier">to_drop</span></a></a><span> </span><a name="local-1627953652"><a href="#local-1627953652"><span class="hs-identifier">ann_expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a href="CoreSyn.html#AnnApp"><span class="hs-identifier hs-var">AnnApp</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a><span> </span><a href="#local-1627953655"><span class="hs-identifier hs-var">ticks</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="FloatIn.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-1627953659"><span class="hs-identifier hs-var">drop_here</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="FloatIn.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-1627953660"><span class="hs-identifier hs-var">extra_drop</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-159"></a><span>    </span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span> </span><span class="hs-special">(</span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953650"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953661"><span class="hs-identifier hs-var">fun_drop</span></a><span> </span><a href="#local-1627953653"><span class="hs-identifier hs-var">ann_fun</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>           </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><span class="hs-special">(</span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953650"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627953662"><span class="hs-identifier hs-var">arg_drops</span></a><span> </span><a href="#local-1627953654"><span class="hs-identifier hs-var">ann_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-162"></a><span>    </span><span class="hs-special">(</span><a name="local-1627953653"><a href="#local-1627953653"><span class="hs-identifier">ann_fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953654"><a href="#local-1627953654"><span class="hs-identifier">ann_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953655"><a href="#local-1627953655"><span class="hs-identifier">ticks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#collectAnnArgsTicks"><span class="hs-identifier hs-var">collectAnnArgsTicks</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-1627953652"><span class="hs-identifier hs-var">ann_expr</span></a><span>
</span><a name="line-163"></a><span>    </span><span class="hs-special">(</span><a name="local-1627953656"><a href="#local-1627953656"><span class="hs-identifier">extra_fvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953657"><a href="#local-1627953657"><span class="hs-identifier">arg_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><a href="#local-1627953658"><span class="hs-identifier hs-var">mk_arg_fvs</span></a><span> </span><a href="VarSet.html#emptyDVarSet"><span class="hs-identifier hs-var">emptyDVarSet</span></a><span> </span><a href="#local-1627953654"><span class="hs-identifier hs-var">ann_args</span></a><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span>    </span><span class="hs-identifier">mk_arg_fvs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FloatIn.html#FreeVarSet"><span class="hs-identifier hs-type">FreeVarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreFVs.html#CoreExprWithFVs"><span class="hs-identifier hs-type">CoreExprWithFVs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="FloatIn.html#FreeVarSet"><span class="hs-identifier hs-type">FreeVarSet</span></a><span class="hs-special">,</span><span> </span><a href="FloatIn.html#FreeVarSet"><span class="hs-identifier hs-type">FreeVarSet</span></a><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>    </span><a name="local-1627953658"><a href="#local-1627953658"><span class="hs-identifier">mk_arg_fvs</span></a></a><span> </span><a name="local-1627953663"><a href="#local-1627953663"><span class="hs-identifier">extra_fvs</span></a></a><span> </span><a name="local-1627953664"><a href="#local-1627953664"><span class="hs-identifier">ann_arg</span></a></a><span>
</span><a name="line-167"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="FloatIn.html#noFloatIntoRhs"><span class="hs-identifier hs-var">noFloatIntoRhs</span></a><span> </span><a href="#local-1627953664"><span class="hs-identifier hs-var">ann_arg</span></a><span>
</span><a name="line-168"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627953663"><span class="hs-identifier hs-var">extra_fvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953664"><span class="hs-identifier hs-var">ann_arg</span></a><span class="hs-special">,</span><span> </span><a href="VarSet.html#emptyDVarSet"><span class="hs-identifier hs-var">emptyDVarSet</span></a><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-170"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627953663"><span class="hs-identifier hs-var">extra_fvs</span></a><span class="hs-special">,</span><span> </span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953664"><span class="hs-identifier hs-var">ann_arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span>    </span><a name="local-1627953659"><a href="#local-1627953659"><span class="hs-identifier">drop_here</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627953660"><a href="#local-1627953660"><span class="hs-identifier">extra_drop</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627953661"><a href="#local-1627953661"><span class="hs-identifier">fun_drop</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627953662"><a href="#local-1627953662"><span class="hs-identifier">arg_drops</span></a></a><span>
</span><a name="line-173"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#sepBindsByDropPoint"><span class="hs-identifier hs-var">sepBindsByDropPoint</span></a><span> </span><a href="#local-1627953650"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-174"></a><span>          </span><span class="hs-special">(</span><a href="#local-1627953656"><span class="hs-identifier hs-var">extra_fvs</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953653"><span class="hs-identifier hs-var">ann_fun</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1627953657"><span class="hs-identifier hs-var">arg_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>          </span><span class="hs-special">(</span><a href="CoreFVs.html#freeVarsOfType"><span class="hs-identifier hs-var">freeVarsOfType</span></a><span> </span><a href="#local-1627953653"><span class="hs-identifier hs-var">ann_fun</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span>
</span><a name="line-176"></a><span>           </span><a href="VarSet.html#mapUnionDVarSet"><span class="hs-identifier hs-var">mapUnionDVarSet</span></a><span> </span><a href="CoreFVs.html#freeVarsOfType"><span class="hs-identifier hs-var">freeVarsOfType</span></a><span> </span><a href="#local-1627953654"><span class="hs-identifier hs-var">ann_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span>          </span><a href="#local-1627953651"><span class="hs-identifier hs-var">to_drop</span></a><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-comment">{-
Note [Do not destroy the let/app invariant]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Watch out for
   f (x +# y)
We don't want to float bindings into here
   f (case ... of { x -&gt; x +# y })
because that might destroy the let/app invariant, which requires
unlifted function arguments to be ok-for-speculation.

Note [Floating in past a lambda group]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* We must be careful about floating inside a value lambda.
  That risks losing laziness.
  The float-out pass might rescue us, but then again it might not.

* We must be careful about type lambdas too.  At one time we did, and
  there is no risk of duplicating work thereby, but we do need to be
  careful.  In particular, here is a bad case (it happened in the
  cichelli benchmark:
        let v = ...
        in let f = /\t -&gt; \a -&gt; ...
           ==&gt;
        let f = /\t -&gt; let v = ... in \a -&gt; ...
  This is bad as now f is an updatable closure (update PAP)
  and has arity 0.

* Hack alert!  We only float in through one-shot lambdas,
  not (as you might guess) through lone big lambdas.
  Reason: we float *out* past big lambdas (see the test in the Lam
  case of FloatOut.floatExpr) and we don't want to float straight
  back in again.

  It *is* important to float into one-shot lambdas, however;
  see the remarks with noFloatIntoRhs.

So we treat lambda in groups, using the following rule:

 Float in if (a) there is at least one Id,
         and (b) there are no non-one-shot Ids

 Otherwise drop all the bindings outside the group.

This is what the 'go' function in the AnnLam case is doing.

Urk! if all are tyvars, and we don't float in, we may miss an
      opportunity to float inside a nested case branch
-}</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-identifier">fiExpr</span><span> </span><a name="local-1627953665"><a href="#local-1627953665"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1627953666"><a href="#local-1627953666"><span class="hs-identifier">to_drop</span></a></a><span> </span><a name="local-1627953667"><a href="#local-1627953667"><span class="hs-identifier">lam</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnLam"><span class="hs-identifier hs-var">AnnLam</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-229"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="FloatIn.html#okToFloatInside"><span class="hs-identifier hs-var">okToFloatInside</span></a><span> </span><a href="#local-1627953668"><span class="hs-identifier hs-var">bndrs</span></a><span>       </span><span class="hs-comment">-- Float in</span><span>
</span><a name="line-230"></a><span>     </span><span class="hs-comment">-- NB: Must line up with noFloatIntoRhs (AnnLam...); see Trac #7088</span><span>
</span><a name="line-231"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><a href="#local-1627953668"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">(</span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953665"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953666"><span class="hs-identifier hs-var">to_drop</span></a><span> </span><a href="#local-1627953669"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>           </span><span class="hs-comment">-- Dump it all here</span><span>
</span><a name="line-234"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-1627953666"><span class="hs-identifier hs-var">to_drop</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><a href="#local-1627953668"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">(</span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953665"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-1627953669"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-237"></a><span>    </span><span class="hs-special">(</span><a name="local-1627953668"><a href="#local-1627953668"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953669"><a href="#local-1627953669"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#collectAnnBndrs"><span class="hs-identifier hs-var">collectAnnBndrs</span></a><span> </span><a href="#local-1627953667"><span class="hs-identifier hs-var">lam</span></a><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-comment">{-
We don't float lets inwards past an SCC.
        ToDo: keep info on current cc, and when passing
        one, if it is not the same, annotate all lets in binds with current
        cc, change current cc to the new one and float binds into expr.
-}</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-identifier">fiExpr</span><span> </span><a name="local-1627953670"><a href="#local-1627953670"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1627953671"><a href="#local-1627953671"><span class="hs-identifier">to_drop</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnTick"><span class="hs-identifier hs-var">AnnTick</span></a><span> </span><a name="local-1627953672"><a href="#local-1627953672"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-1627953673"><a href="#local-1627953673"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627953672"><span class="hs-identifier hs-var">tickish</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#tickishScopesLike"><span class="hs-identifier hs-var">tickishScopesLike</span></a><span class="hs-special">`</span><span> </span><a href="CoreSyn.html#SoftScope"><span class="hs-identifier hs-var">SoftScope</span></a><span>
</span><a name="line-248"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-1627953672"><span class="hs-identifier hs-var">tickish</span></a><span> </span><span class="hs-special">(</span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953670"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953671"><span class="hs-identifier hs-var">to_drop</span></a><span> </span><a href="#local-1627953673"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-comment">-- Wimp out for now - we could push values in</span><span>
</span><a name="line-251"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-1627953671"><span class="hs-identifier hs-var">to_drop</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-1627953672"><span class="hs-identifier hs-var">tickish</span></a><span> </span><span class="hs-special">(</span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953670"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-1627953673"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span class="hs-comment">{-
For @Lets@, the possible ``drop points'' for the \tr{to_drop}
bindings are: (a)~in the body, (b1)~in the RHS of a NonRec binding,
or~(b2), in each of the RHSs of the pairs of a @Rec@.

Note that we do {\em weird things} with this let's binding.  Consider:
\begin{verbatim}
let
    w = ...
in {
    let v = ... w ...
    in ... v .. w ...
}
\end{verbatim}
Look at the inner \tr{let}.  As \tr{w} is used in both the bind and
body of the inner let, we could panic and leave \tr{w}'s binding where
it is.  But \tr{v} is floatable further into the body of the inner let, and
{\em then} \tr{w} will also be only in the body of that inner let.

So: rather than drop \tr{w}'s binding here, we add it onto the list of
things to drop in the outer let's body, and let nature take its
course.

Note [extra_fvs (1): avoid floating into RHS]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider let x=\y....t... in body.  We do not necessarily want to float
a binding for t into the RHS, because it'll immediately be floated out
again.  (It won't go inside the lambda else we risk losing work.)
In letrec, we need to be more careful still. We don't want to transform
        let x# = y# +# 1#
        in
        letrec f = \z. ...x#...f...
        in ...
into
        letrec f = let x# = y# +# 1# in \z. ...x#...f... in ...
because now we can't float the let out again, because a letrec
can't have unboxed bindings.

So we make &quot;extra_fvs&quot; which is the rhs_fvs of such bindings, and
arrange to dump bindings that bind extra_fvs before the entire let.

Note [extra_fvs (2): free variables of rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  let x{rule mentioning y} = rhs in body
Here y is not free in rhs or body; but we still want to dump bindings
that bind y outside the let.  So we augment extra_fvs with the
idRuleAndUnfoldingVars of x.  No need for type variables, hence not using
idFreeVars.
-}</span><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span class="hs-identifier">fiExpr</span><span> </span><a name="local-1627953674"><a href="#local-1627953674"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1627953675"><a href="#local-1627953675"><span class="hs-identifier">to_drop</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a href="CoreSyn.html#AnnLet"><span class="hs-identifier hs-var">AnnLet</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnNonRec"><span class="hs-identifier hs-var">AnnNonRec</span></a><span> </span><a name="local-1627953676"><a href="#local-1627953676"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-1627953677"><a href="#local-1627953677"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627953678"><a href="#local-1627953678"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953674"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953687"><span class="hs-identifier hs-var">new_to_drop</span></a><span> </span><a href="#local-1627953678"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-306"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-307"></a><span>    </span><a name="local-1627953679"><a href="#local-1627953679"><span class="hs-identifier">body_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953678"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#delDVarSet"><span class="hs-identifier hs-var">delDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627953676"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-308"></a><span>    </span><a name="local-1627953680"><a href="#local-1627953680"><span class="hs-identifier">rhs_fvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953677"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span>    </span><a name="local-1627953681"><a href="#local-1627953681"><span class="hs-identifier">rule_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#idRuleAndUnfoldingVarsDSet"><span class="hs-identifier hs-var">idRuleAndUnfoldingVarsDSet</span></a><span> </span><a href="#local-1627953676"><span class="hs-identifier hs-var">id</span></a><span>        </span><span class="hs-comment">-- See Note [extra_fvs (2): free variables of rules]</span><span>
</span><a name="line-311"></a><span>    </span><a name="local-1627953682"><a href="#local-1627953682"><span class="hs-identifier">extra_fvs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="FloatIn.html#noFloatIntoRhs"><span class="hs-identifier hs-var">noFloatIntoRhs</span></a><span> </span><a href="#local-1627953677"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953681"><span class="hs-identifier hs-var">rule_fvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953677"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-312"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953681"><span class="hs-identifier hs-var">rule_fvs</span></a><span>
</span><a name="line-313"></a><span>        </span><span class="hs-comment">-- See Note [extra_fvs (1): avoid floating into RHS]</span><span>
</span><a name="line-314"></a><span>        </span><span class="hs-comment">-- No point in floating in only to float straight out again</span><span>
</span><a name="line-315"></a><span>        </span><span class="hs-comment">-- Ditto ok-for-speculation unlifted RHSs</span><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span>    </span><span class="hs-special">[</span><a name="local-1627953683"><a href="#local-1627953683"><span class="hs-identifier">shared_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953684"><a href="#local-1627953684"><span class="hs-identifier">extra_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953685"><a href="#local-1627953685"><span class="hs-identifier">rhs_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953686"><a href="#local-1627953686"><span class="hs-identifier">body_binds</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-318"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#sepBindsByDropPoint"><span class="hs-identifier hs-var">sepBindsByDropPoint</span></a><span> </span><a href="#local-1627953674"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-319"></a><span>            </span><span class="hs-special">[</span><a href="#local-1627953682"><span class="hs-identifier hs-var">extra_fvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627953680"><span class="hs-identifier hs-var">rhs_fvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627953679"><span class="hs-identifier hs-var">body_fvs</span></a><span class="hs-special">]</span><span>
</span><a name="line-320"></a><span>            </span><span class="hs-special">(</span><a href="CoreFVs.html#freeVarsOfType"><span class="hs-identifier hs-var">freeVarsOfType</span></a><span> </span><a href="#local-1627953677"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="CoreFVs.html#freeVarsOfType"><span class="hs-identifier hs-var">freeVarsOfType</span></a><span> </span><a href="#local-1627953678"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-321"></a><span>            </span><a href="#local-1627953675"><span class="hs-identifier hs-var">to_drop</span></a><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span>    </span><a name="local-1627953687"><a href="#local-1627953687"><span class="hs-identifier">new_to_drop</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953686"><span class="hs-identifier hs-var">body_binds</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>                         </span><span class="hs-comment">-- the bindings used only in the body</span><span>
</span><a name="line-324"></a><span>                  </span><span class="hs-special">[</span><a href="FloatIn.html#FB"><span class="hs-identifier hs-var">FB</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#unitDVarSet"><span class="hs-identifier hs-var">unitDVarSet</span></a><span> </span><a href="#local-1627953676"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627953689"><span class="hs-identifier hs-var">rhs_fvs'</span></a><span>
</span><a name="line-325"></a><span>                      </span><span class="hs-special">(</span><a href="MkCore.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-1627953676"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-1627953688"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>   </span><span class="hs-comment">-- the new binding itself</span><span>
</span><a name="line-326"></a><span>                  </span><a href="#local-1627953684"><span class="hs-identifier hs-var">extra_binds</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>                        </span><span class="hs-comment">-- bindings from extra_fvs</span><span>
</span><a name="line-327"></a><span>                  </span><a href="#local-1627953683"><span class="hs-identifier hs-var">shared_binds</span></a><span>                          </span><span class="hs-comment">-- the bindings used both in rhs and body</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span>        </span><span class="hs-comment">-- Push rhs_binds into the right hand side of the binding</span><span>
</span><a name="line-330"></a><span>    </span><a name="local-1627953688"><a href="#local-1627953688"><span class="hs-identifier">rhs'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953674"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953685"><span class="hs-identifier hs-var">rhs_binds</span></a><span> </span><a href="#local-1627953677"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-331"></a><span>    </span><a name="local-1627953689"><a href="#local-1627953689"><span class="hs-identifier">rhs_fvs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953680"><span class="hs-identifier hs-var">rhs_fvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="FloatIn.html#floatedBindsFVs"><span class="hs-identifier hs-var">floatedBindsFVs</span></a><span> </span><a href="#local-1627953685"><span class="hs-identifier hs-var">rhs_binds</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627953681"><span class="hs-identifier hs-var">rule_fvs</span></a><span>
</span><a name="line-332"></a><span>                        </span><span class="hs-comment">-- Don't forget the rule_fvs; the binding mentions them!</span><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span class="hs-identifier">fiExpr</span><span> </span><a name="local-1627953690"><a href="#local-1627953690"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1627953691"><a href="#local-1627953691"><span class="hs-identifier">to_drop</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a href="CoreSyn.html#AnnLet"><span class="hs-identifier hs-var">AnnLet</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnRec"><span class="hs-identifier hs-var">AnnRec</span></a><span> </span><a name="local-1627953692"><a href="#local-1627953692"><span class="hs-identifier">bindings</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627953693"><a href="#local-1627953693"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953690"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953704"><span class="hs-identifier hs-var">new_to_drop</span></a><span> </span><a href="#local-1627953693"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-336"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-337"></a><span>    </span><span class="hs-special">(</span><a name="local-1627953694"><a href="#local-1627953694"><span class="hs-identifier">ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953695"><a href="#local-1627953695"><span class="hs-identifier">rhss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="#local-1627953692"><span class="hs-identifier hs-var">bindings</span></a><span>
</span><a name="line-338"></a><span>    </span><a name="local-1627953696"><a href="#local-1627953696"><span class="hs-identifier">rhss_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953695"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-339"></a><span>    </span><a name="local-1627953697"><a href="#local-1627953697"><span class="hs-identifier">body_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953693"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-340"></a><span>
</span><a name="line-341"></a><span>        </span><span class="hs-comment">-- See Note [extra_fvs (1,2)]</span><span>
</span><a name="line-342"></a><span>    </span><a name="local-1627953698"><a href="#local-1627953698"><span class="hs-identifier">rule_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mapUnionDVarSet"><span class="hs-identifier hs-var">mapUnionDVarSet</span></a><span> </span><a href="CoreFVs.html#idRuleAndUnfoldingVarsDSet"><span class="hs-identifier hs-var">idRuleAndUnfoldingVarsDSet</span></a><span> </span><a href="#local-1627953694"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-343"></a><span>    </span><a name="local-1627953699"><a href="#local-1627953699"><span class="hs-identifier">extra_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953698"><span class="hs-identifier hs-var">rule_fvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span>
</span><a name="line-344"></a><span>                </span><a href="VarSet.html#unionDVarSets"><span class="hs-identifier hs-var">unionDVarSets</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953707"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-1627953707"><a href="#local-1627953707"><span class="hs-identifier">rhs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1627953708"><a href="#local-1627953708"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627953695"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-345"></a><span>                              </span><span class="hs-special">,</span><span> </span><a href="FloatIn.html#noFloatIntoExpr"><span class="hs-identifier hs-var">noFloatIntoExpr</span></a><span> </span><a href="#local-1627953708"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span>    </span><span class="hs-special">(</span><a name="local-1627953700"><a href="#local-1627953700"><span class="hs-identifier">shared_binds</span></a></a><span class="hs-glyph">:</span><a name="local-1627953701"><a href="#local-1627953701"><span class="hs-identifier">extra_binds</span></a></a><span class="hs-glyph">:</span><a name="local-1627953702"><a href="#local-1627953702"><span class="hs-identifier">body_binds</span></a></a><span class="hs-glyph">:</span><a name="local-1627953703"><a href="#local-1627953703"><span class="hs-identifier">rhss_binds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-348"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#sepBindsByDropPoint"><span class="hs-identifier hs-var">sepBindsByDropPoint</span></a><span> </span><a href="#local-1627953690"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-349"></a><span>            </span><span class="hs-special">(</span><a href="#local-1627953699"><span class="hs-identifier hs-var">extra_fvs</span></a><span class="hs-glyph">:</span><a href="#local-1627953697"><span class="hs-identifier hs-var">body_fvs</span></a><span class="hs-glyph">:</span><a href="#local-1627953696"><span class="hs-identifier hs-var">rhss_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-350"></a><span>            </span><span class="hs-special">(</span><a href="CoreFVs.html#freeVarsOfType"><span class="hs-identifier hs-var">freeVarsOfType</span></a><span> </span><a href="#local-1627953693"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="VarSet.html#mapUnionDVarSet"><span class="hs-identifier hs-var">mapUnionDVarSet</span></a><span> </span><a href="CoreFVs.html#freeVarsOfType"><span class="hs-identifier hs-var">freeVarsOfType</span></a><span> </span><a href="#local-1627953695"><span class="hs-identifier hs-var">rhss</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>            </span><a href="#local-1627953691"><span class="hs-identifier hs-var">to_drop</span></a><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span>    </span><a name="local-1627953704"><a href="#local-1627953704"><span class="hs-identifier">new_to_drop</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953702"><span class="hs-identifier hs-var">body_binds</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>         </span><span class="hs-comment">-- the bindings used only in the body</span><span>
</span><a name="line-354"></a><span>                  </span><span class="hs-special">[</span><a href="FloatIn.html#FB"><span class="hs-identifier hs-var">FB</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#mkDVarSet"><span class="hs-identifier hs-var">mkDVarSet</span></a><span> </span><a href="#local-1627953694"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627953705"><span class="hs-identifier hs-var">rhs_fvs'</span></a><span>
</span><a name="line-355"></a><span>                      </span><span class="hs-special">(</span><a href="MkCore.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627953706"><span class="hs-identifier hs-var">fi_bind</span></a><span> </span><a href="#local-1627953703"><span class="hs-identifier hs-var">rhss_binds</span></a><span> </span><a href="#local-1627953692"><span class="hs-identifier hs-var">bindings</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-356"></a><span>                                        </span><span class="hs-comment">-- The new binding itself</span><span>
</span><a name="line-357"></a><span>                  </span><a href="#local-1627953701"><span class="hs-identifier hs-var">extra_binds</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>        </span><span class="hs-comment">-- Note [extra_fvs (1,2)]</span><span>
</span><a name="line-358"></a><span>                  </span><a href="#local-1627953700"><span class="hs-identifier hs-var">shared_binds</span></a><span>          </span><span class="hs-comment">-- Used in more than one place</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span>    </span><a name="local-1627953705"><a href="#local-1627953705"><span class="hs-identifier">rhs_fvs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#unionDVarSets"><span class="hs-identifier hs-var">unionDVarSets</span></a><span> </span><a href="#local-1627953696"><span class="hs-identifier hs-var">rhss_fvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span>
</span><a name="line-361"></a><span>               </span><a href="VarSet.html#unionDVarSets"><span class="hs-identifier hs-var">unionDVarSets</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="FloatIn.html#floatedBindsFVs"><span class="hs-identifier hs-var">floatedBindsFVs</span></a><span> </span><a href="#local-1627953703"><span class="hs-identifier hs-var">rhss_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span>
</span><a name="line-362"></a><span>               </span><a href="#local-1627953698"><span class="hs-identifier hs-var">rule_fvs</span></a><span>         </span><span class="hs-comment">-- Don't forget the rule variables!</span><span>
</span><a name="line-363"></a><span>
</span><a name="line-364"></a><span>    </span><span class="hs-comment">-- Push rhs_binds into the right hand side of the binding</span><span>
</span><a name="line-365"></a><span>    </span><span class="hs-identifier">fi_bind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="FloatIn.html#FloatInBinds"><span class="hs-identifier hs-type">FloatInBinds</span></a><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- one per &quot;drop pt&quot; conjured w/ fvs_of_rhss</span><span>
</span><a name="line-366"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="CoreFVs.html#CoreExprWithFVs"><span class="hs-identifier hs-type">CoreExprWithFVs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-367"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span>    </span><a name="local-1627953706"><a href="#local-1627953706"><span class="hs-identifier">fi_bind</span></a></a><span> </span><a name="local-1627953709"><a href="#local-1627953709"><span class="hs-identifier">to_drops</span></a></a><span> </span><a name="local-1627953710"><a href="#local-1627953710"><span class="hs-identifier">pairs</span></a></a><span>
</span><a name="line-370"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-1627953711"><span class="hs-identifier hs-var">binder</span></a><span class="hs-special">,</span><span> </span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953690"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953713"><span class="hs-identifier hs-var">to_drop</span></a><span> </span><a href="#local-1627953712"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-1627953711"><a href="#local-1627953711"><span class="hs-identifier">binder</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953712"><a href="#local-1627953712"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-1627953713"><a href="#local-1627953713"><span class="hs-identifier">to_drop</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Util.html#zipEqual"><span class="hs-identifier hs-var">zipEqual</span></a><span> </span><span class="hs-string">&quot;fi_bind&quot;</span><span> </span><a href="#local-1627953710"><span class="hs-identifier hs-var">pairs</span></a><span> </span><a href="#local-1627953709"><span class="hs-identifier hs-var">to_drops</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-comment">{-
For @Case@, the possible ``drop points'' for the \tr{to_drop}
bindings are: (a)~inside the scrutinee, (b)~inside one of the
alternatives/default [default FVs always {\em first}!].

Floating case expressions inward was added to fix Trac #5658: strict bindings
not floated in. In particular, this change allows array indexing operations,
which have a single DEFAULT alternative without any binders, to be floated
inward. SIMD primops for unpacking SIMD vectors into an unboxed tuple of unboxed
scalars also need to be floated inward, but unpacks have a single non-DEFAULT
alternative that binds the elements of the tuple. We now therefore also support
floating in cases with a single alternative that may bind values.
-}</span><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span class="hs-identifier">fiExpr</span><span> </span><a name="local-1627953714"><a href="#local-1627953714"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1627953715"><a href="#local-1627953715"><span class="hs-identifier">to_drop</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnCase"><span class="hs-identifier hs-var">AnnCase</span></a><span> </span><a name="local-1627953716"><a href="#local-1627953716"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-1627953717"><a href="#local-1627953717"><span class="hs-identifier">case_bndr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a name="local-1627953718"><a href="#local-1627953718"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><a name="local-1627953719"><a href="#local-1627953719"><span class="hs-identifier">alt_bndrs</span></a></a><span class="hs-special">,</span><a name="local-1627953720"><a href="#local-1627953720"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1627953717"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-389"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#exprOkForSideEffects"><span class="hs-identifier hs-var">exprOkForSideEffects</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deAnnotate"><span class="hs-identifier hs-var">deAnnotate</span></a><span> </span><a href="#local-1627953716"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>      </span><span class="hs-comment">-- See PrimOp, Note [PrimOp can_fail and has_side_effects]</span><span>
</span><a name="line-391"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-1627953723"><span class="hs-identifier hs-var">shared_binds</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-392"></a><span>    </span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953714"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627953721"><span class="hs-identifier hs-var">case_float</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1627953725"><span class="hs-identifier hs-var">rhs_binds</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627953720"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-393"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-394"></a><span>    </span><a name="local-1627953721"><a href="#local-1627953721"><span class="hs-identifier">case_float</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#FB"><span class="hs-identifier hs-var">FB</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#mkDVarSet"><span class="hs-identifier hs-var">mkDVarSet</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627953717"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1627953719"><span class="hs-identifier hs-var">alt_bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1627953728"><span class="hs-identifier hs-var">scrut_fvs</span></a><span>
</span><a name="line-395"></a><span>                    </span><span class="hs-special">(</span><a href="MkCore.html#FloatCase"><span class="hs-identifier hs-var">FloatCase</span></a><span> </span><a href="#local-1627953722"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-1627953717"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-1627953718"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1627953719"><span class="hs-identifier hs-var">alt_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>    </span><a name="local-1627953722"><a href="#local-1627953722"><span class="hs-identifier">scrut'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953714"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953724"><span class="hs-identifier hs-var">scrut_binds</span></a><span> </span><a href="#local-1627953716"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-397"></a><span>    </span><span class="hs-special">[</span><a name="local-1627953723"><a href="#local-1627953723"><span class="hs-identifier">shared_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953724"><a href="#local-1627953724"><span class="hs-identifier">scrut_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953725"><a href="#local-1627953725"><span class="hs-identifier">rhs_binds</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-398"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#sepBindsByDropPoint"><span class="hs-identifier hs-var">sepBindsByDropPoint</span></a><span> </span><a href="#local-1627953714"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-399"></a><span>           </span><span class="hs-special">[</span><a href="#local-1627953728"><span class="hs-identifier hs-var">scrut_fvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627953726"><span class="hs-identifier hs-var">rhs_fvs</span></a><span class="hs-special">]</span><span>
</span><a name="line-400"></a><span>           </span><span class="hs-special">(</span><a href="CoreFVs.html#freeVarsOfType"><span class="hs-identifier hs-var">freeVarsOfType</span></a><span> </span><a href="#local-1627953716"><span class="hs-identifier hs-var">scrut</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627953727"><span class="hs-identifier hs-var">rhs_ty_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>           </span><a href="#local-1627953715"><span class="hs-identifier hs-var">to_drop</span></a><span>
</span><a name="line-402"></a><span>    </span><a name="local-1627953726"><a href="#local-1627953726"><span class="hs-identifier">rhs_fvs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953720"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#delDVarSetList"><span class="hs-identifier hs-var">delDVarSetList</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-1627953717"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1627953719"><span class="hs-identifier hs-var">alt_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-403"></a><span>    </span><a name="local-1627953727"><a href="#local-1627953727"><span class="hs-identifier">rhs_ty_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#freeVarsOfType"><span class="hs-identifier hs-var">freeVarsOfType</span></a><span> </span><a href="#local-1627953720"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#delDVarSetList"><span class="hs-identifier hs-var">delDVarSetList</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-1627953717"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1627953719"><span class="hs-identifier hs-var">alt_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-404"></a><span>    </span><a name="local-1627953728"><a href="#local-1627953728"><span class="hs-identifier">scrut_fvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953716"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span class="hs-identifier">fiExpr</span><span> </span><a name="local-1627953729"><a href="#local-1627953729"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1627953730"><a href="#local-1627953730"><span class="hs-identifier">to_drop</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnCase"><span class="hs-identifier hs-var">AnnCase</span></a><span> </span><a name="local-1627953731"><a href="#local-1627953731"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-1627953732"><a href="#local-1627953732"><span class="hs-identifier">case_bndr</span></a></a><span> </span><a name="local-1627953733"><a href="#local-1627953733"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-1627953734"><a href="#local-1627953734"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-1627953735"><span class="hs-identifier hs-var">drop_here1</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-408"></a><span>    </span><a href="FloatIn.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-1627953738"><span class="hs-identifier hs-var">drop_here2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-409"></a><span>    </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><span class="hs-special">(</span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953729"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953736"><span class="hs-identifier hs-var">scrut_drops</span></a><span> </span><a href="#local-1627953731"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627953732"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-1627953733"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-410"></a><span>         </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><a href="#local-1627953747"><span class="hs-identifier hs-var">fi_alt</span></a><span> </span><a href="#local-1627953739"><span class="hs-identifier hs-var">alts_drops_s</span></a><span> </span><a href="#local-1627953734"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-412"></a><span>        </span><span class="hs-comment">-- Float into the scrut and alts-considered-together just like App</span><span>
</span><a name="line-413"></a><span>    </span><span class="hs-special">[</span><a name="local-1627953735"><a href="#local-1627953735"><span class="hs-identifier">drop_here1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953736"><a href="#local-1627953736"><span class="hs-identifier">scrut_drops</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953737"><a href="#local-1627953737"><span class="hs-identifier">alts_drops</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-414"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#sepBindsByDropPoint"><span class="hs-identifier hs-var">sepBindsByDropPoint</span></a><span> </span><a href="#local-1627953729"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-415"></a><span>           </span><span class="hs-special">[</span><a href="#local-1627953740"><span class="hs-identifier hs-var">scrut_fvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627953742"><span class="hs-identifier hs-var">all_alts_fvs</span></a><span class="hs-special">]</span><span>
</span><a name="line-416"></a><span>           </span><span class="hs-special">(</span><a href="CoreFVs.html#freeVarsOfType"><span class="hs-identifier hs-var">freeVarsOfType</span></a><span> </span><a href="#local-1627953731"><span class="hs-identifier hs-var">scrut</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627953744"><span class="hs-identifier hs-var">all_alts_ty_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-417"></a><span>           </span><a href="#local-1627953730"><span class="hs-identifier hs-var">to_drop</span></a><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span>        </span><span class="hs-comment">-- Float into the alts with the is_case flag set</span><span>
</span><a name="line-420"></a><span>    </span><span class="hs-special">(</span><a name="local-1627953738"><a href="#local-1627953738"><span class="hs-identifier">drop_here2</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627953739"><a href="#local-1627953739"><span class="hs-identifier">alts_drops_s</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-421"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#sepBindsByDropPoint"><span class="hs-identifier hs-var">sepBindsByDropPoint</span></a><span> </span><a href="#local-1627953729"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-1627953741"><span class="hs-identifier hs-var">alts_fvs</span></a><span> </span><a href="#local-1627953744"><span class="hs-identifier hs-var">all_alts_ty_fvs</span></a><span> </span><a href="#local-1627953737"><span class="hs-identifier hs-var">alts_drops</span></a><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span>    </span><a name="local-1627953740"><a href="#local-1627953740"><span class="hs-identifier">scrut_fvs</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953731"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-424"></a><span>    </span><a name="local-1627953741"><a href="#local-1627953741"><span class="hs-identifier">alts_fvs</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1627953745"><span class="hs-identifier hs-var">alt_fvs</span></a><span> </span><a href="#local-1627953734"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-425"></a><span>    </span><a name="local-1627953742"><a href="#local-1627953742"><span class="hs-identifier">all_alts_fvs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#unionDVarSets"><span class="hs-identifier hs-var">unionDVarSets</span></a><span> </span><a href="#local-1627953741"><span class="hs-identifier hs-var">alts_fvs</span></a><span>
</span><a name="line-426"></a><span>    </span><a name="local-1627953743"><a href="#local-1627953743"><span class="hs-identifier">alts_ty_fvs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1627953746"><span class="hs-identifier hs-var">alt_ty_fvs</span></a><span> </span><a href="#local-1627953734"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-427"></a><span>    </span><a name="local-1627953744"><a href="#local-1627953744"><span class="hs-identifier">all_alts_ty_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#unionDVarSets"><span class="hs-identifier hs-var">unionDVarSets</span></a><span> </span><a href="#local-1627953743"><span class="hs-identifier hs-var">alts_ty_fvs</span></a><span>
</span><a name="line-428"></a><span>    </span><a name="local-1627953745"><a href="#local-1627953745"><span class="hs-identifier">alt_fvs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627953748"><a href="#local-1627953748"><span class="hs-identifier">_con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953749"><a href="#local-1627953749"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953750"><a href="#local-1627953750"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-429"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl"><span class="hs-identifier hs-var">foldl</span></a><span> </span><a href="VarSet.html#delDVarSet"><span class="hs-identifier hs-var">delDVarSet</span></a><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#freeVarsOf"><span class="hs-identifier hs-var">freeVarsOf</span></a><span> </span><a href="#local-1627953750"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>     </span><span class="hs-special">(</span><a href="#local-1627953732"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-glyph">:</span><a href="#local-1627953749"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>    </span><a name="local-1627953746"><a href="#local-1627953746"><span class="hs-identifier">alt_ty_fvs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627953751"><a href="#local-1627953751"><span class="hs-identifier">_con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953752"><a href="#local-1627953752"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953753"><a href="#local-1627953753"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-431"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl"><span class="hs-identifier hs-var">foldl</span></a><span> </span><a href="VarSet.html#delDVarSet"><span class="hs-identifier hs-var">delDVarSet</span></a><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#freeVarsOfType"><span class="hs-identifier hs-var">freeVarsOfType</span></a><span> </span><a href="#local-1627953753"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627953732"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-glyph">:</span><a href="#local-1627953752"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-432"></a><span>                                </span><span class="hs-comment">-- Delete case_bndr and args from free vars of rhs</span><span>
</span><a name="line-433"></a><span>                                </span><span class="hs-comment">-- to get free vars of alt</span><span>
</span><a name="line-434"></a><span>
</span><a name="line-435"></a><span>    </span><a name="local-1627953747"><a href="#local-1627953747"><span class="hs-identifier">fi_alt</span></a></a><span> </span><a name="local-1627953754"><a href="#local-1627953754"><span class="hs-identifier">to_drop</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627953755"><a href="#local-1627953755"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953756"><a href="#local-1627953756"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627953757"><a href="#local-1627953757"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627953755"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627953756"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><a href="FloatIn.html#fiExpr"><span class="hs-identifier hs-var">fiExpr</span></a><span> </span><a href="#local-1627953729"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953754"><span class="hs-identifier hs-var">to_drop</span></a><span> </span><a href="#local-1627953757"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span class="hs-identifier">okToFloatInside</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-438"></a><a name="okToFloatInside"><a href="FloatIn.html#okToFloatInside"><span class="hs-identifier">okToFloatInside</span></a></a><span> </span><a name="local-1627953758"><a href="#local-1627953758"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="#local-1627953759"><span class="hs-identifier hs-var">ok</span></a><span> </span><a href="#local-1627953758"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-439"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-440"></a><span>    </span><a name="local-1627953759"><a href="#local-1627953759"><span class="hs-identifier">ok</span></a></a><span> </span><a name="local-1627953760"><a href="#local-1627953760"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-1627953760"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="Id.html#isOneShotBndr"><span class="hs-identifier hs-var">isOneShotBndr</span></a><span> </span><a href="#local-1627953760"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-441"></a><span>    </span><span class="hs-comment">-- Push the floats inside there are no non-one-shot value binders</span><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span class="hs-identifier">noFloatIntoRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreFVs.html#CoreExprWithFVs"><span class="hs-identifier hs-type">CoreExprWithFVs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-444"></a><span class="hs-comment">-- ^ True if it's a bad idea to float bindings into this RHS</span><span>
</span><a name="line-445"></a><span class="hs-comment">-- Preconditio:  rhs :: rhs_ty</span><span>
</span><a name="line-446"></a><a name="noFloatIntoRhs"><a href="FloatIn.html#noFloatIntoRhs"><span class="hs-identifier">noFloatIntoRhs</span></a></a><span> </span><a name="local-1627953761"><a href="#local-1627953761"><span class="hs-identifier">rhs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1627953762"><a href="#local-1627953762"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-447"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a href="Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a><span> </span><a href="#local-1627953763"><span class="hs-identifier hs-var">rhs_ty</span></a><span>   </span><span class="hs-comment">-- See Note [Do not destroy the let/app invariant]</span><span>
</span><a name="line-448"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><a href="FloatIn.html#noFloatIntoExpr"><span class="hs-identifier hs-var">noFloatIntoExpr</span></a><span> </span><a href="#local-1627953762"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-449"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-450"></a><span>    </span><a name="local-1627953763"><a href="#local-1627953763"><span class="hs-identifier">rhs_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#exprTypeFV"><span class="hs-identifier hs-var">exprTypeFV</span></a><span> </span><a href="#local-1627953761"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span class="hs-identifier">noFloatIntoExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreFVs.html#CoreExprWithFVs%27"><span class="hs-identifier hs-type">CoreExprWithFVs'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-453"></a><a name="noFloatIntoExpr"><a href="FloatIn.html#noFloatIntoExpr"><span class="hs-identifier">noFloatIntoExpr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnLam"><span class="hs-identifier hs-var">AnnLam</span></a><span> </span><a name="local-1627953764"><a href="#local-1627953764"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-1627953765"><a href="#local-1627953765"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-454"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="FloatIn.html#okToFloatInside"><span class="hs-identifier hs-var">okToFloatInside</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627953764"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-glyph">:</span><a href="#local-1627953766"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>     </span><span class="hs-comment">-- NB: Must line up with fiExpr (AnnLam...); see Trac #7088</span><span>
</span><a name="line-456"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-457"></a><span>     </span><span class="hs-special">(</span><a name="local-1627953766"><a href="#local-1627953766"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#collectAnnBndrs"><span class="hs-identifier hs-var">collectAnnBndrs</span></a><span> </span><a href="#local-1627953765"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-458"></a><span>        </span><span class="hs-comment">-- IMPORTANT: don't say 'True' for a RHS with a one-shot lambda at the top.</span><span>
</span><a name="line-459"></a><span>        </span><span class="hs-comment">-- This makes a big difference for things like</span><span>
</span><a name="line-460"></a><span>        </span><span class="hs-comment">--      f x# = let x = I# x#</span><span>
</span><a name="line-461"></a><span>        </span><span class="hs-comment">--             in let j = \() -&gt; ...x...</span><span>
</span><a name="line-462"></a><span>        </span><span class="hs-comment">--                in if &lt;condition&gt; then normal-path else j ()</span><span>
</span><a name="line-463"></a><span>        </span><span class="hs-comment">-- If x is used only in the error case join point, j, we must float the</span><span>
</span><a name="line-464"></a><span>        </span><span class="hs-comment">-- boxing constructor into it, else we box it every time which is very bad</span><span>
</span><a name="line-465"></a><span>        </span><span class="hs-comment">-- news indeed.</span><span>
</span><a name="line-466"></a><span>
</span><a name="line-467"></a><span class="hs-identifier">noFloatIntoExpr</span><span> </span><a name="local-1627953767"><a href="#local-1627953767"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsExpandable"><span class="hs-identifier hs-var">exprIsExpandable</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deAnnotate%27"><span class="hs-identifier hs-var">deAnnotate'</span></a><span> </span><a href="#local-1627953767"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-468"></a><span>       </span><span class="hs-comment">-- We'd just float right back out again...</span><span>
</span><a name="line-469"></a><span>       </span><span class="hs-comment">-- Should match the test in SimplEnv.doFloatFromRhs</span><span>
</span><a name="line-470"></a><span>
</span><a name="line-471"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{@sepBindsByDropPoint@}
*                                                                      *
************************************************************************

This is the crucial function.  The idea is: We have a wad of bindings
that we'd like to distribute inside a collection of {\em drop points};
insides the alternatives of a \tr{case} would be one example of some
drop points; the RHS and body of a non-recursive \tr{let} binding
would be another (2-element) collection.

So: We're given a list of sets-of-free-variables, one per drop point,
and a list of floating-inwards bindings.  If a binding can go into
only one drop point (without suddenly making something out-of-scope),
in it goes.  If a binding is used inside {\em multiple} drop points,
then it has to go in a you-must-drop-it-above-all-these-drop-points
point.

But, with coercions appearing in types, there is a complication: we
might be floating in a &quot;strict let&quot; -- that is, a case. Case expressions
mention their return type. We absolutely can't float a coercion binding
inward to the point that the type of the expression it's about to wrap
mentions the coercion. So we include the union of the sets of free variables
of the types of all the drop points involved. If any of the floaters
bind a coercion variable mentioned in any of the types, that binder must
be dropped right away.

We have to maintain the order on these drop-point-related lists.
-}</span><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span class="hs-identifier">sepBindsByDropPoint</span><span>
</span><a name="line-504"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-505"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>             </span><span class="hs-comment">-- True &lt;=&gt; is case expression</span><span>
</span><a name="line-506"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FloatIn.html#FreeVarSet"><span class="hs-identifier hs-type">FreeVarSet</span></a><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- One set of FVs per drop point</span><span>
</span><a name="line-507"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FloatIn.html#FreeVarSet"><span class="hs-identifier hs-type">FreeVarSet</span></a><span>           </span><span class="hs-comment">-- Vars free in all the types of the drop points</span><span>
</span><a name="line-508"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FloatIn.html#FloatInBinds"><span class="hs-identifier hs-type">FloatInBinds</span></a><span>         </span><span class="hs-comment">-- Candidate floaters</span><span>
</span><a name="line-509"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FloatIn.html#FloatInBinds"><span class="hs-identifier hs-type">FloatInBinds</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- FIRST one is bindings which must not be floated</span><span>
</span><a name="line-510"></a><span>                            </span><span class="hs-comment">-- inside any drop point; the rest correspond</span><span>
</span><a name="line-511"></a><span>                            </span><span class="hs-comment">-- one-to-one with the input list of FV sets</span><span>
</span><a name="line-512"></a><span>
</span><a name="line-513"></a><span class="hs-comment">-- Every input floater is returned somewhere in the result;</span><span>
</span><a name="line-514"></a><span class="hs-comment">-- none are dropped, not even ones which don't seem to be</span><span>
</span><a name="line-515"></a><span class="hs-comment">-- free in *any* of the drop-point fvs.  Why?  Because, for example,</span><span>
</span><a name="line-516"></a><span class="hs-comment">-- a binding (let x = E in B) might have a specialised version of</span><span>
</span><a name="line-517"></a><span class="hs-comment">-- x (say x') stored inside x, but x' isn't free in E or B.</span><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span class="hs-keyword">type</span><span> </span><a name="DropBox"><a href="FloatIn.html#DropBox"><span class="hs-identifier">DropBox</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="FloatIn.html#FreeVarSet"><span class="hs-identifier hs-type">FreeVarSet</span></a><span class="hs-special">,</span><span> </span><a href="FloatIn.html#FloatInBinds"><span class="hs-identifier hs-type">FloatInBinds</span></a><span class="hs-special">)</span><span>
</span><a name="line-520"></a><span>
</span><a name="line-521"></a><a name="sepBindsByDropPoint"><a href="FloatIn.html#sepBindsByDropPoint"><span class="hs-identifier">sepBindsByDropPoint</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627953768"><a href="#local-1627953768"><span class="hs-identifier">_is_case</span></a></a><span> </span><a name="local-1627953769"><a href="#local-1627953769"><span class="hs-identifier">drop_pts</span></a></a><span> </span><a name="local-1627953770"><a href="#local-1627953770"><span class="hs-identifier">_ty_fvs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-522"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627953769"><span class="hs-identifier hs-var">drop_pts</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- cut to the chase scene; it happens</span><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><span class="hs-identifier">sepBindsByDropPoint</span><span> </span><a name="local-1627953771"><a href="#local-1627953771"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1627953772"><a href="#local-1627953772"><span class="hs-identifier">is_case</span></a></a><span> </span><a name="local-1627953773"><a href="#local-1627953773"><span class="hs-identifier">drop_pts</span></a></a><span> </span><a name="local-1627953774"><a href="#local-1627953774"><span class="hs-identifier">ty_fvs</span></a></a><span> </span><a name="local-1627953775"><a href="#local-1627953775"><span class="hs-identifier">floaters</span></a></a><span>
</span><a name="line-525"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953776"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627953775"><span class="hs-identifier hs-var">floaters</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627953802"><a href="#local-1627953802"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1627953802"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="VarSet.html#emptyDVarSet"><span class="hs-identifier hs-var">emptyDVarSet</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1627953773"><span class="hs-identifier hs-var">drop_pts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-527"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FloatIn.html#FloatInBinds"><span class="hs-identifier hs-type">FloatInBinds</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FloatIn.html#DropBox"><span class="hs-identifier hs-type">DropBox</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FloatIn.html#FloatInBinds"><span class="hs-identifier hs-type">FloatInBinds</span></a><span class="hs-special">]</span><span>
</span><a name="line-528"></a><span>        </span><span class="hs-comment">-- The *first* one in the argument list is the drop_here set</span><span>
</span><a name="line-529"></a><span>        </span><span class="hs-comment">-- The FloatInBinds in the lists are in the reverse of</span><span>
</span><a name="line-530"></a><span>        </span><span class="hs-comment">-- the normal FloatInBinds order; that is, they are the right way round!</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span>    </span><a name="local-1627953776"><a href="#local-1627953776"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-1627953777"><a href="#local-1627953777"><span class="hs-identifier">drop_boxes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627953777"><span class="hs-identifier hs-var">drop_boxes</span></a><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-1627953778"><a href="#local-1627953778"><span class="hs-identifier">bind_w_fvs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FloatIn.html#FB"><span class="hs-identifier hs-var">FB</span></a><span> </span><a name="local-1627953779"><a href="#local-1627953779"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-1627953780"><a href="#local-1627953780"><span class="hs-identifier">bind_fvs</span></a></a><span> </span><a name="local-1627953781"><a href="#local-1627953781"><span class="hs-identifier">bind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627953782"><a href="#local-1627953782"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627953783"><a href="#local-1627953783"><span class="hs-identifier">drop_boxes</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-1627953784"><a href="#local-1627953784"><span class="hs-identifier">here_box</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627953785"><a href="#local-1627953785"><span class="hs-identifier">fork_boxes</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-535"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953776"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627953782"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-1627953793"><span class="hs-identifier hs-var">new_boxes</span></a><span>
</span><a name="line-536"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-537"></a><span>          </span><span class="hs-comment">-- &quot;here&quot; means the group of bindings dropped at the top of the fork</span><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span>          </span><span class="hs-special">(</span><a name="local-1627953786"><a href="#local-1627953786"><span class="hs-identifier">used_here</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627953787"><a href="#local-1627953787"><span class="hs-identifier">used_in_flags</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1627953797"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#intersectsDVarSet"><span class="hs-identifier hs-var">intersectsDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627953779"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-540"></a><span>                                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-1627953797"><a href="#local-1627953797"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627953783"><span class="hs-identifier hs-var">drop_boxes</span></a><span class="hs-special">]</span><span>
</span><a name="line-541"></a><span>          </span><a name="local-1627953788"><a href="#local-1627953788"><span class="hs-identifier">used_in_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953774"><span class="hs-identifier hs-var">ty_fvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#intersectsDVarSet"><span class="hs-identifier hs-var">intersectsDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627953779"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span>          </span><a name="local-1627953789"><a href="#local-1627953789"><span class="hs-identifier">drop_here</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953786"><span class="hs-identifier hs-var">used_here</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1627953792"><span class="hs-identifier hs-var">can_push</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627953788"><span class="hs-identifier hs-var">used_in_ty</span></a><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span>                </span><span class="hs-comment">-- For case expressions we duplicate the binding if it is</span><span>
</span><a name="line-546"></a><span>                </span><span class="hs-comment">-- reasonably small, and if it is not used in all the RHSs</span><span>
</span><a name="line-547"></a><span>                </span><span class="hs-comment">-- This is good for situations like</span><span>
</span><a name="line-548"></a><span>                </span><span class="hs-comment">--      let x = I# y in</span><span>
</span><a name="line-549"></a><span>                </span><span class="hs-comment">--      case e of</span><span>
</span><a name="line-550"></a><span>                </span><span class="hs-comment">--        C -&gt; error x</span><span>
</span><a name="line-551"></a><span>                </span><span class="hs-comment">--        D -&gt; error x</span><span>
</span><a name="line-552"></a><span>                </span><span class="hs-comment">--        E -&gt; ...not mentioning x...</span><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span>          </span><a name="local-1627953790"><a href="#local-1627953790"><span class="hs-identifier">n_alts</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627953787"><span class="hs-identifier hs-var">used_in_flags</span></a><span>
</span><a name="line-555"></a><span>          </span><a name="local-1627953791"><a href="#local-1627953791"><span class="hs-identifier">n_used_alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#count"><span class="hs-identifier hs-var">count</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-1627953787"><span class="hs-identifier hs-var">used_in_flags</span></a><span> </span><span class="hs-comment">-- returns number of Trues in list.</span><span>
</span><a name="line-556"></a><span>
</span><a name="line-557"></a><span>          </span><a name="local-1627953792"><a href="#local-1627953792"><span class="hs-identifier">can_push</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953791"><span class="hs-identifier hs-var">n_used_alts</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span>           </span><span class="hs-comment">-- Used in just one branch</span><span>
</span><a name="line-558"></a><span>                   </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="#local-1627953772"><span class="hs-identifier hs-var">is_case</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>               </span><span class="hs-comment">-- We are looking at case alternatives</span><span>
</span><a name="line-559"></a><span>                       </span><a href="#local-1627953791"><span class="hs-identifier hs-var">n_used_alts</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>       </span><span class="hs-comment">-- It's used in more than one</span><span>
</span><a name="line-560"></a><span>                       </span><a href="#local-1627953791"><span class="hs-identifier hs-var">n_used_alts</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-1627953790"><span class="hs-identifier hs-var">n_alts</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>  </span><span class="hs-comment">-- ...but not all</span><span>
</span><a name="line-561"></a><span>                       </span><a href="FloatIn.html#floatIsDupable"><span class="hs-identifier hs-var">floatIsDupable</span></a><span> </span><a href="#local-1627953771"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953781"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- and we can duplicate the binding</span><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span>          </span><a name="local-1627953793"><a href="#local-1627953793"><span class="hs-identifier">new_boxes</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627953789"><span class="hs-identifier hs-var">drop_here</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627953795"><span class="hs-identifier hs-var">insert</span></a><span> </span><a href="#local-1627953784"><span class="hs-identifier hs-var">here_box</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1627953785"><span class="hs-identifier hs-var">fork_boxes</span></a><span class="hs-special">)</span><span>
</span><a name="line-564"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627953784"><span class="hs-identifier hs-var">here_box</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1627953794"><span class="hs-identifier hs-var">new_fork_boxes</span></a><span class="hs-special">)</span><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span>          </span><a name="local-1627953794"><a href="#local-1627953794"><span class="hs-identifier">new_fork_boxes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#zipWithEqual"><span class="hs-identifier hs-var">zipWithEqual</span></a><span> </span><span class="hs-string">&quot;FloatIn.sepBinds&quot;</span><span> </span><a href="#local-1627953796"><span class="hs-identifier hs-var">insert_maybe</span></a><span> </span><a href="#local-1627953785"><span class="hs-identifier hs-var">fork_boxes</span></a><span> </span><a href="#local-1627953787"><span class="hs-identifier hs-var">used_in_flags</span></a><span>
</span><a name="line-567"></a><span>
</span><a name="line-568"></a><span>          </span><span class="hs-identifier">insert</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FloatIn.html#DropBox"><span class="hs-identifier hs-type">DropBox</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FloatIn.html#DropBox"><span class="hs-identifier hs-type">DropBox</span></a><span>
</span><a name="line-569"></a><span>          </span><a name="local-1627953795"><a href="#local-1627953795"><span class="hs-identifier">insert</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627953798"><a href="#local-1627953798"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">,</span><a name="local-1627953799"><a href="#local-1627953799"><span class="hs-identifier">drops</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627953798"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627953780"><span class="hs-identifier hs-var">bind_fvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627953778"><span class="hs-identifier hs-var">bind_w_fvs</span></a><span class="hs-glyph">:</span><a href="#local-1627953799"><span class="hs-identifier hs-var">drops</span></a><span class="hs-special">)</span><span>
</span><a name="line-570"></a><span>
</span><a name="line-571"></a><span>          </span><a name="local-1627953796"><a href="#local-1627953796"><span class="hs-identifier">insert_maybe</span></a></a><span> </span><a name="local-1627953800"><a href="#local-1627953800"><span class="hs-identifier">box</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953795"><span class="hs-identifier hs-var">insert</span></a><span> </span><a href="#local-1627953800"><span class="hs-identifier hs-var">box</span></a><span>
</span><a name="line-572"></a><span>          </span><span class="hs-identifier">insert_maybe</span><span> </span><a name="local-1627953801"><a href="#local-1627953801"><span class="hs-identifier">box</span></a></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953801"><span class="hs-identifier hs-var">box</span></a><span>
</span><a name="line-573"></a><span>
</span><a name="line-574"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;sepBindsByDropPoint/go&quot;</span><span>
</span><a name="line-575"></a><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span class="hs-identifier">floatedBindsFVs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FloatIn.html#FloatInBinds"><span class="hs-identifier hs-type">FloatInBinds</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FloatIn.html#FreeVarSet"><span class="hs-identifier hs-type">FreeVarSet</span></a><span>
</span><a name="line-578"></a><a name="floatedBindsFVs"><a href="FloatIn.html#floatedBindsFVs"><span class="hs-identifier">floatedBindsFVs</span></a></a><span> </span><a name="local-1627953803"><a href="#local-1627953803"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mapUnionDVarSet"><span class="hs-identifier hs-var">mapUnionDVarSet</span></a><span> </span><a href="FloatIn.html#fbFVs"><span class="hs-identifier hs-var">fbFVs</span></a><span> </span><a href="#local-1627953803"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-579"></a><span>
</span><a name="line-580"></a><span class="hs-identifier">fbFVs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FloatIn.html#FloatInBind"><span class="hs-identifier hs-type">FloatInBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#DVarSet"><span class="hs-identifier hs-type">DVarSet</span></a><span>
</span><a name="line-581"></a><a name="fbFVs"><a href="FloatIn.html#fbFVs"><span class="hs-identifier">fbFVs</span></a></a><span> </span><span class="hs-special">(</span><a href="FloatIn.html#FB"><span class="hs-identifier hs-var">FB</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627953804"><a href="#local-1627953804"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953804"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span class="hs-identifier">wrapFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FloatIn.html#FloatInBinds"><span class="hs-identifier hs-type">FloatInBinds</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-584"></a><span class="hs-comment">-- Remember FloatInBinds is in *reverse* dependency order</span><span>
</span><a name="line-585"></a><a name="wrapFloats"><a href="FloatIn.html#wrapFloats"><span class="hs-identifier">wrapFloats</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>               </span><a name="local-1627953805"><a href="#local-1627953805"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627953805"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-586"></a><span class="hs-identifier">wrapFloats</span><span> </span><span class="hs-special">(</span><a href="FloatIn.html#FB"><span class="hs-identifier hs-var">FB</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627953806"><a href="#local-1627953806"><span class="hs-identifier">fl</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627953807"><a href="#local-1627953807"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627953808"><a href="#local-1627953808"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FloatIn.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span> </span><a href="#local-1627953807"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-special">(</span><a href="MkCore.html#wrapFloat"><span class="hs-identifier hs-var">wrapFloat</span></a><span> </span><a href="#local-1627953806"><span class="hs-identifier hs-var">fl</span></a><span> </span><a href="#local-1627953808"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span class="hs-identifier">floatIsDupable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkCore.html#FloatBind"><span class="hs-identifier hs-type">FloatBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-589"></a><a name="floatIsDupable"><a href="FloatIn.html#floatIsDupable"><span class="hs-identifier">floatIsDupable</span></a></a><span> </span><a name="local-1627953809"><a href="#local-1627953809"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="MkCore.html#FloatCase"><span class="hs-identifier hs-var">FloatCase</span></a><span> </span><a name="local-1627953810"><a href="#local-1627953810"><span class="hs-identifier">scrut</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsDupable"><span class="hs-identifier hs-var">exprIsDupable</span></a><span> </span><a href="#local-1627953809"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953810"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-590"></a><span class="hs-identifier">floatIsDupable</span><span> </span><a name="local-1627953811"><a href="#local-1627953811"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="MkCore.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-1627953812"><a href="#local-1627953812"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprIsDupable"><span class="hs-identifier hs-var">exprIsDupable</span></a><span> </span><a href="#local-1627953811"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627953812"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-591"></a><span class="hs-identifier">floatIsDupable</span><span> </span><a name="local-1627953813"><a href="#local-1627953813"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="MkCore.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627953814"><a href="#local-1627953814"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsDupable"><span class="hs-identifier hs-var">exprIsDupable</span></a><span> </span><a href="#local-1627953813"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627953814"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-592"></a></pre></body></html>