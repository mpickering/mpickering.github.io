<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- The @FamInst@ type: family instance heads</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE CPP, GADTs #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">FamInst</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-6"></a><span>        </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span class="hs-special">,</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-7"></a><span>        </span><a href="FamInst.html#checkFamInstConsistency"><span class="hs-identifier hs-var">checkFamInstConsistency</span></a><span class="hs-special">,</span><span> </span><a href="FamInst.html#tcExtendLocalFamInstEnv"><span class="hs-identifier hs-var">tcExtendLocalFamInstEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-8"></a><span>        </span><a href="FamInst.html#tcLookupDataFamInst"><span class="hs-identifier hs-var">tcLookupDataFamInst</span></a><span class="hs-special">,</span><span> </span><a href="FamInst.html#tcLookupDataFamInst_maybe"><span class="hs-identifier hs-var">tcLookupDataFamInst_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-9"></a><span>        </span><a href="FamInst.html#tcInstNewTyCon_maybe"><span class="hs-identifier hs-var">tcInstNewTyCon_maybe</span></a><span class="hs-special">,</span><span> </span><a href="FamInst.html#tcTopNormaliseNewTypeTF_maybe"><span class="hs-identifier hs-var">tcTopNormaliseNewTypeTF_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span>        </span><a href="FamInst.html#newFamInst"><span class="hs-identifier hs-var">newFamInst</span></a><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span>        </span><span class="hs-comment">-- * Injectivity</span><span>
</span><a name="line-13"></a><span>        </span><a href="FamInst.html#makeInjectivityErrors"><span class="hs-identifier hs-var">makeInjectivityErrors</span></a><span>
</span><a name="line-14"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="HscTypes.html"><span class="hs-identifier">HscTypes</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="FamInstEnv.html"><span class="hs-identifier">FamInstEnv</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="InstEnv.html"><span class="hs-identifier">InstEnv</span></a><span class="hs-special">(</span><span> </span><a href="Unify.html#roughMatchTcs"><span class="hs-identifier hs-var">roughMatchTcs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="TcEvidence.html"><span class="hs-identifier">TcEvidence</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="LoadIface.html"><span class="hs-identifier">LoadIface</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="SrcLoc.html"><span class="hs-identifier">SrcLoc</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="TcType.html"><span class="hs-identifier">TcType</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="CoAxiom.html"><span class="hs-identifier">CoAxiom</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Module.html"><span class="hs-identifier">Module</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="UniqFM.html"><span class="hs-identifier">UniqFM</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="RdrName.html"><span class="hs-identifier">RdrName</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="DataCon.html"><span class="hs-identifier">DataCon</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="DataCon.html#dataConName"><span class="hs-identifier hs-var">dataConName</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="TyCoRep.html"><span class="hs-identifier">TyCoRep</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="Pair.html"><span class="hs-identifier">Pair</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="Panic.html"><span class="hs-identifier">Panic</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="../containers-0.5.7.1/src/%{MODULE/./-}.html#%{NAME}/Data.Map.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span></a><span> </span><span class="hs-special">(</span><a href="../containers-0.5.7.1/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Base.html#Map"><span class="hs-identifier hs-type">Map</span></a><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../containers-0.5.7.1/src/%{MODULE/./-}.html#%{NAME}/Data.Map.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                 Making a FamInst
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-comment">-- All type variables in a FamInst must be fresh. This function</span><span>
</span><a name="line-57"></a><span class="hs-comment">-- creates the fresh variables and applies the necessary substitution</span><span>
</span><a name="line-58"></a><span class="hs-comment">-- It is defined here to avoid a dependency from FamInstEnv on the monad</span><span>
</span><a name="line-59"></a><span class="hs-comment">-- code.</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-identifier">newFamInst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamFlavor"><span class="hs-identifier hs-type">FamFlavor</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcRnIf"><span class="hs-identifier hs-type">TcRnIf</span></a><span> </span><a href="#local-1628032764"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-1628032765"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span>
</span><a name="line-62"></a><span class="hs-comment">-- Freshen the type variables of the FamInst branches</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- Called from the vectoriser monad too, hence the rather general type</span><span>
</span><a name="line-64"></a><a name="newFamInst"><a href="FamInst.html#newFamInst"><span class="hs-identifier">newFamInst</span></a></a><span> </span><a name="local-1628032766"><a href="#local-1628032766"><span class="hs-identifier">flavor</span></a></a><span> </span><a name="local-1628032767"><a href="#local-1628032767"><span class="hs-identifier">axiom</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-var">CoAxiom</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">co_ax_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628032768"><a href="#local-1628032768"><span class="hs-identifier">fam_tc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">tyCoVarsOfTypes</span><span> </span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">lhs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">subVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">tcv_set</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;lhs&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">pp_ax</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">tyCoVarsOfType</span><span>  </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">subVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">tcv_set</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;rhs&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">pp_ax</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">lhs_kind</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">rhs_kind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;kind&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">pp_ax</span><span> </span><a href="Outputable.html#assertPprPanic"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#assertPprPanic"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-identifier">lhs_kind</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">rhs_kind</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628032777"><a href="#local-1628032777"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628032778"><a href="#local-1628032778"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#freshenTyVarBndrs"><span class="hs-identifier hs-var">freshenTyVarBndrs</span></a><span> </span><a href="#local-1628032773"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-69"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628032779"><a href="#local-1628032779"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628032780"><a href="#local-1628032780"><span class="hs-identifier">cvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#freshenCoVarBndrsX"><span class="hs-identifier hs-var">freshenCoVarBndrsX</span></a><span> </span><a href="#local-1628032777"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1628032774"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-70"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_fam</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-1628032768"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-71"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_flavor</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032766"><span class="hs-identifier hs-var">flavor</span></a><span>
</span><a name="line-72"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_tcs</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Unify.html#roughMatchTcs"><span class="hs-identifier hs-var">roughMatchTcs</span></a><span> </span><a href="#local-1628032775"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-73"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_tvs</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032778"><span class="hs-identifier hs-var">tvs'</span></a><span>
</span><a name="line-74"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_cvs</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032780"><span class="hs-identifier hs-var">cvs'</span></a><span>
</span><a name="line-75"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_tys</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTys"><span class="hs-identifier hs-var">substTys</span></a><span> </span><a href="#local-1628032779"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1628032775"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-76"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_rhs</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span>  </span><a href="#local-1628032779"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1628032776"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-77"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_axiom</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032767"><span class="hs-identifier hs-var">axiom</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-78"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-79"></a><span>    </span><a name="local-1628032769"><a href="#local-1628032769"><span class="hs-identifier">lhs_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-1628032768"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-1628032775"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>    </span><a name="local-1628032770"><a href="#local-1628032770"><span class="hs-identifier">rhs_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-1628032776"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-81"></a><span>    </span><a name="local-1628032771"><a href="#local-1628032771"><span class="hs-identifier">tcv_set</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628032773"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628032774"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span>    </span><a name="local-1628032772"><a href="#local-1628032772"><span class="hs-identifier">pp_ax</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#pprCoAxiom"><span class="hs-identifier hs-var">pprCoAxiom</span></a><span> </span><a href="#local-1628032767"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-83"></a><span>    </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628032773"><a href="#local-1628032773"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-84"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_cvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628032774"><a href="#local-1628032774"><span class="hs-identifier">cvs</span></a></a><span>
</span><a name="line-85"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628032775"><a href="#local-1628032775"><span class="hs-identifier">lhs</span></a></a><span>
</span><a name="line-86"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628032776"><a href="#local-1628032776"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a><span> </span><a href="#local-1628032767"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Optimised overlap checking for family instances
*                                                                      *
************************************************************************

For any two family instance modules that we import directly or indirectly, we
check whether the instances in the two modules are consistent, *unless* we can
be certain that the instances of the two modules have already been checked for
consistency during the compilation of modules that we import.

Why do we need to check?  Consider
   module X1 where                module X2 where
    data T1                         data T2
    type instance F T1 b = Int      type instance F a T2 = Char
    f1 :: F T1 a -&gt; Int             f2 :: Char -&gt; F a T2
    f1 x = x                        f2 x = x

Now if we import both X1 and X2 we could make (f2 . f1) :: Int -&gt; Char.
Notice that neither instance is an orphan.

How do we know which pairs of modules have already been checked?  Any pair of
modules where both modules occur in the `HscTypes.dep_finsts' set (of the
`HscTypes.Dependencies') of one of our directly imported modules must have
already been checked.  Everything else, we check now.  (So that we can be
certain that the modules in our `HscTypes.dep_finsts' are consistent.)
-}</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-comment">-- The optimisation of overlap tests is based on determining pairs of modules</span><span>
</span><a name="line-119"></a><span class="hs-comment">-- whose family instances need to be checked for consistency.</span><span>
</span><a name="line-120"></a><span class="hs-comment">--</span><span>
</span><a name="line-121"></a><span class="hs-keyword">data</span><span> </span><a name="ModulePair"><a href="FamInst.html#ModulePair"><span class="hs-identifier">ModulePair</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ModulePair"><a href="FamInst.html#ModulePair"><span class="hs-identifier">ModulePair</span></a></a><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-comment">-- canonical order of the components of a module pair</span><span>
</span><a name="line-124"></a><span class="hs-comment">--</span><span>
</span><a name="line-125"></a><span class="hs-identifier">canon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInst.html#ModulePair"><span class="hs-identifier hs-type">ModulePair</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">,</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><a name="canon"><a href="FamInst.html#canon"><span class="hs-identifier">canon</span></a></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#ModulePair"><span class="hs-identifier hs-var">ModulePair</span></a><span> </span><a name="local-1628032781"><a href="#local-1628032781"><span class="hs-identifier">m1</span></a></a><span> </span><a name="local-1628032782"><a href="#local-1628032782"><span class="hs-identifier">m2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628032781"><span class="hs-identifier hs-var">m1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-1628032782"><span class="hs-identifier hs-var">m2</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1628032781"><span class="hs-identifier hs-var">m1</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032782"><span class="hs-identifier hs-var">m2</span></a><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1628032782"><span class="hs-identifier hs-var">m2</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032781"><span class="hs-identifier hs-var">m1</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="FamInst.html#ModulePair"><span class="hs-identifier hs-type">ModulePair</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-130"></a><span>  </span><a name="local-1628032973"><a href="#local-1628032973"><span class="hs-identifier">mp1</span></a></a><span> </span><a name="local-805306535"><span class="hs-operator">==</span></a><span> </span><a name="local-1628032974"><a href="#local-1628032974"><span class="hs-identifier">mp2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#canon"><span class="hs-identifier hs-var">canon</span></a><span> </span><a href="#local-1628032973"><span class="hs-identifier hs-var">mp1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="FamInst.html#canon"><span class="hs-identifier hs-var">canon</span></a><span> </span><a href="#local-1628032974"><span class="hs-identifier hs-var">mp2</span></a><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="FamInst.html#ModulePair"><span class="hs-identifier hs-type">ModulePair</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-133"></a><span>  </span><a name="local-1628032971"><a href="#local-1628032971"><span class="hs-identifier">mp1</span></a></a><span> </span><span class="hs-special">`</span><a name="local-1912608689"><span class="hs-identifier">compare</span></a><span class="hs-special">`</span><span> </span><a name="local-1628032972"><a href="#local-1628032972"><span class="hs-identifier">mp2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#canon"><span class="hs-identifier hs-var">canon</span></a><span> </span><a href="#local-1628032971"><span class="hs-identifier hs-var">mp1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">compare</span><span class="hs-special">`</span><span> </span><a href="FamInst.html#canon"><span class="hs-identifier hs-var">canon</span></a><span> </span><a href="#local-1628032972"><span class="hs-identifier hs-var">mp2</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="FamInst.html#ModulePair"><span class="hs-identifier hs-type">ModulePair</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-136"></a><span>  </span><a name="local-1912686315"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#ModulePair"><span class="hs-identifier hs-var">ModulePair</span></a><span> </span><a name="local-1628032969"><a href="#local-1628032969"><span class="hs-identifier">m1</span></a></a><span> </span><a name="local-1628032970"><a href="#local-1628032970"><span class="hs-identifier">m2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#angleBrackets"><span class="hs-identifier hs-var">angleBrackets</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628032969"><span class="hs-identifier hs-var">m1</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628032970"><span class="hs-identifier hs-var">m2</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-comment">-- Sets of module pairs</span><span>
</span><a name="line-139"></a><span class="hs-comment">--</span><span>
</span><a name="line-140"></a><span class="hs-keyword">type</span><span> </span><a name="ModulePairSet"><a href="FamInst.html#ModulePairSet"><span class="hs-identifier">ModulePairSet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.7.1/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Base.html#Map"><span class="hs-identifier hs-type">Map</span></a><span> </span><a href="FamInst.html#ModulePair"><span class="hs-identifier hs-type">ModulePair</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-identifier">listToSet</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="FamInst.html#ModulePair"><span class="hs-identifier hs-type">ModulePair</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInst.html#ModulePairSet"><span class="hs-identifier hs-type">ModulePairSet</span></a><span>
</span><a name="line-143"></a><a name="listToSet"><a href="FamInst.html#listToSet"><span class="hs-identifier">listToSet</span></a></a><span> </span><a name="local-1628032783"><a href="#local-1628032783"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.7.1/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Base.html#fromList"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-1628032783"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#repeat"><span class="hs-identifier hs-var">repeat</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-identifier">checkFamInstConsistency</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-146"></a><a name="checkFamInstConsistency"><a href="FamInst.html#checkFamInstConsistency"><span class="hs-identifier">checkFamInstConsistency</span></a></a><span> </span><a name="local-1628032784"><a href="#local-1628032784"><span class="hs-identifier">famInstMods</span></a></a><span> </span><a name="local-1628032785"><a href="#local-1628032785"><span class="hs-identifier">directlyImpMods</span></a></a><span>
</span><a name="line-147"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628032795"><a href="#local-1628032795"><span class="hs-identifier">dflags</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-148"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628032796"><a href="#local-1628032796"><span class="hs-identifier">eps</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628032797"><a href="#local-1628032797"><span class="hs-identifier">hpt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEpsAndHpt"><span class="hs-identifier hs-var">getEpsAndHpt</span></a><span>
</span><a name="line-149"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Fetch the iface of a given module.  Must succeed as</span><span>
</span><a name="line-150"></a><span>               </span><span class="hs-comment">-- all directly imported modules must already have been loaded.</span><span>
</span><a name="line-151"></a><span>               </span><a name="local-1628032798"><a href="#local-1628032798"><span class="hs-identifier">modIface</span></a></a><span> </span><a name="local-1628032806"><a href="#local-1628032806"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-152"></a><span>                 </span><span class="hs-keyword">case</span><span> </span><a href="HscTypes.html#lookupIfaceByModule"><span class="hs-identifier hs-var">lookupIfaceByModule</span></a><span> </span><a href="#local-1628032795"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628032797"><span class="hs-identifier hs-var">hpt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_PIT</span><span> </span><a href="#local-1628032796"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628032806"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-153"></a><span>                   </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Panic.html#panicDoc"><span class="hs-identifier hs-var">panicDoc</span></a><span> </span><span class="hs-string">&quot;FamInst.checkFamInstConsistency&quot;</span><span>
</span><a name="line-154"></a><span>                                          </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628032806"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="HscTypes.html#pprHPT"><span class="hs-identifier hs-var">pprHPT</span></a><span> </span><a href="#local-1628032797"><span class="hs-identifier hs-var">hpt</span></a><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>                   </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628032807"><a href="#local-1628032807"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628032807"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-1628032799"><a href="#local-1628032799"><span class="hs-identifier">hmiModule</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_module</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><span class="hs-identifier">hm_iface</span><span>
</span><a name="line-158"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-1628032800"><a href="#local-1628032800"><span class="hs-identifier">hmiFamInstEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#extendFamInstEnvList"><span class="hs-identifier hs-var">extendFamInstEnvList</span></a><span> </span><a href="FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier hs-var">emptyFamInstEnv</span></a><span>
</span><a name="line-159"></a><span>                               </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><span class="hs-identifier">md_fam_insts</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><span class="hs-identifier">hm_details</span><span>
</span><a name="line-160"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-1628032801"><a href="#local-1628032801"><span class="hs-identifier">hpt_fam_insts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#mkModuleEnv"><span class="hs-identifier hs-var">mkModuleEnv</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-1628032799"><span class="hs-identifier hs-var">hmiModule</span></a><span> </span><a href="#local-1628032808"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032800"><span class="hs-identifier hs-var">hmiFamInstEnv</span></a><span> </span><a href="#local-1628032808"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>                                           </span><span class="hs-glyph">|</span><span> </span><a name="local-1628032808"><a href="#local-1628032808"><span class="hs-identifier">hmi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UniqFM.html#eltsUFM"><span class="hs-identifier hs-var">eltsUFM</span></a><span> </span><a href="#local-1628032797"><span class="hs-identifier hs-var">hpt</span></a><span class="hs-special">]</span><span>
</span><a name="line-162"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-1628032802"><a href="#local-1628032802"><span class="hs-identifier">groups</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dep_finsts</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><span class="hs-identifier">mi_deps</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="#local-1628032798"><span class="hs-identifier hs-var">modIface</span></a><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>                                   </span><a href="#local-1628032785"><span class="hs-identifier hs-var">directlyImpMods</span></a><span>
</span><a name="line-164"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-1628032803"><a href="#local-1628032803"><span class="hs-identifier">okPairs</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#listToSet"><span class="hs-identifier hs-var">listToSet</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a><span> </span><a href="#local-1628032786"><span class="hs-identifier hs-var">allPairs</span></a><span> </span><a href="#local-1628032802"><span class="hs-identifier hs-var">groups</span></a><span>
</span><a name="line-165"></a><span>                 </span><span class="hs-comment">-- instances of okPairs are consistent</span><span>
</span><a name="line-166"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-1628032804"><a href="#local-1628032804"><span class="hs-identifier">criticalPairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#listToSet"><span class="hs-identifier hs-var">listToSet</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1628032786"><span class="hs-identifier hs-var">allPairs</span></a><span> </span><a href="#local-1628032784"><span class="hs-identifier hs-var">famInstMods</span></a><span>
</span><a name="line-167"></a><span>                 </span><span class="hs-comment">-- all pairs that we need to consider</span><span>
</span><a name="line-168"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-1628032805"><a href="#local-1628032805"><span class="hs-identifier">toCheckPairs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.7.1/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Base.html#keys"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">keys</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1628032804"><span class="hs-identifier hs-var">criticalPairs</span></a><span> </span><span class="hs-special">`</span><a href="../containers-0.5.7.1/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Base.html#difference"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">difference</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628032803"><span class="hs-identifier hs-var">okPairs</span></a><span>
</span><a name="line-169"></a><span>                 </span><span class="hs-comment">-- the difference gives us the pairs we need to check now</span><span>
</span><a name="line-170"></a><span>             </span><span class="hs-special">}</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628032787"><span class="hs-identifier hs-var">check</span></a><span> </span><a href="#local-1628032801"><span class="hs-identifier hs-var">hpt_fam_insts</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628032805"><span class="hs-identifier hs-var">toCheckPairs</span></a><span>
</span><a name="line-173"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-174"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-175"></a><span>    </span><a name="local-1628032786"><a href="#local-1628032786"><span class="hs-identifier">allPairs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-identifier">allPairs</span><span> </span><span class="hs-special">(</span><a name="local-1628032788"><a href="#local-1628032788"><span class="hs-identifier">m</span></a></a><span class="hs-glyph">:</span><a name="local-1628032789"><a href="#local-1628032789"><span class="hs-identifier">ms</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#ModulePair"><span class="hs-identifier hs-var">ModulePair</span></a><span> </span><a href="#local-1628032788"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628032789"><span class="hs-identifier hs-var">ms</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628032786"><span class="hs-identifier hs-var">allPairs</span></a><span> </span><a href="#local-1628032789"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>    </span><a name="local-1628032787"><a href="#local-1628032787"><span class="hs-identifier">check</span></a></a><span> </span><a name="local-1628032790"><a href="#local-1628032790"><span class="hs-identifier">hpt_fam_insts</span></a></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#ModulePair"><span class="hs-identifier hs-var">ModulePair</span></a><span> </span><a name="local-1628032791"><a href="#local-1628032791"><span class="hs-identifier">m1</span></a></a><span> </span><a name="local-1628032792"><a href="#local-1628032792"><span class="hs-identifier">m2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628032793"><a href="#local-1628032793"><span class="hs-identifier">env1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#getFamInsts"><span class="hs-identifier hs-var">getFamInsts</span></a><span> </span><a href="#local-1628032790"><span class="hs-identifier hs-var">hpt_fam_insts</span></a><span> </span><a href="#local-1628032791"><span class="hs-identifier hs-var">m1</span></a><span>
</span><a name="line-180"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628032794"><a href="#local-1628032794"><span class="hs-identifier">env2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#getFamInsts"><span class="hs-identifier hs-var">getFamInsts</span></a><span> </span><a href="#local-1628032790"><span class="hs-identifier hs-var">hpt_fam_insts</span></a><span> </span><a href="#local-1628032792"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-181"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#checkForConflicts"><span class="hs-identifier hs-var">checkForConflicts</span></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier hs-var">emptyFamInstEnv</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032794"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span>                   </span><span class="hs-special">(</span><a href="FamInstEnv.html#famInstEnvElts"><span class="hs-identifier hs-var">famInstEnvElts</span></a><span> </span><a href="#local-1628032793"><span class="hs-identifier hs-var">env1</span></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#checkForInjectivityConflicts"><span class="hs-identifier hs-var">checkForInjectivityConflicts</span></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier hs-var">emptyFamInstEnv</span></a><span class="hs-special">,</span><a href="#local-1628032794"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>                   </span><span class="hs-special">(</span><a href="FamInstEnv.html#famInstEnvElts"><span class="hs-identifier hs-var">famInstEnvElts</span></a><span> </span><a href="#local-1628032793"><span class="hs-identifier hs-var">env1</span></a><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-identifier">getFamInsts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Module.html#ModuleEnv"><span class="hs-identifier hs-type">ModuleEnv</span></a><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span>
</span><a name="line-189"></a><a name="getFamInsts"><a href="FamInst.html#getFamInsts"><span class="hs-identifier">getFamInsts</span></a></a><span> </span><a name="local-1628032809"><a href="#local-1628032809"><span class="hs-identifier">hpt_fam_insts</span></a></a><span> </span><a name="local-1628032810"><a href="#local-1628032810"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-190"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628032812"><a href="#local-1628032812"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Module.html#lookupModuleEnv"><span class="hs-identifier hs-var">lookupModuleEnv</span></a><span> </span><a href="#local-1628032809"><span class="hs-identifier hs-var">hpt_fam_insts</span></a><span> </span><a href="#local-1628032810"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628032812"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-191"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier hs-var">initIfaceTcRn</span></a><span> </span><span class="hs-special">(</span><a href="LoadIface.html#loadSysInterface"><span class="hs-identifier hs-var">loadSysInterface</span></a><span> </span><a href="#local-1628032811"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-1628032810"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>                   </span><span class="hs-special">;</span><span> </span><a name="local-1628032813"><a href="#local-1628032813"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEps"><span class="hs-identifier hs-var">getEps</span></a><span>
</span><a name="line-193"></a><span>                   </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Maybes.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a><span> </span><span class="hs-string">&quot;checkFamInstConsistency&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-194"></a><span>                             </span><a href="Module.html#lookupModuleEnv"><span class="hs-identifier hs-var">lookupModuleEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_mod_fam_inst_env</span><span> </span><a href="#local-1628032813"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628032810"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-195"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-196"></a><span>    </span><a name="local-1628032811"><a href="#local-1628032811"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628032810"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;is a family-instance module&quot;</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Lookup
*                                                                      *
************************************************************************

-}</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-comment">-- | If @co :: T ts ~ rep_ty@ then:</span><span>
</span><a name="line-208"></a><span class="hs-comment">--</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- &gt; instNewTyCon_maybe T ts = Just (rep_ty, co)</span><span>
</span><a name="line-210"></a><span class="hs-comment">--</span><span>
</span><a name="line-211"></a><span class="hs-comment">-- Checks for a newtype, and for being saturated</span><span>
</span><a name="line-212"></a><span class="hs-comment">-- Just like Coercion.instNewTyCon_maybe, but returns a TcCoercion</span><span>
</span><a name="line-213"></a><span class="hs-identifier">tcInstNewTyCon_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#TcCoercion"><span class="hs-identifier hs-type">TcCoercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><a name="tcInstNewTyCon_maybe"><a href="FamInst.html#tcInstNewTyCon_maybe"><span class="hs-identifier">tcInstNewTyCon_maybe</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#instNewTyCon_maybe"><span class="hs-identifier hs-var">instNewTyCon_maybe</span></a><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-comment">-- | Like 'tcLookupDataFamInst_maybe', but returns the arguments back if</span><span>
</span><a name="line-217"></a><span class="hs-comment">-- there is no data family to unwrap.</span><span>
</span><a name="line-218"></a><span class="hs-comment">-- Returns a Representational coercion</span><span>
</span><a name="line-219"></a><span class="hs-identifier">tcLookupDataFamInst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span>
</span><a name="line-220"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><a name="tcLookupDataFamInst"><a href="FamInst.html#tcLookupDataFamInst"><span class="hs-identifier">tcLookupDataFamInst</span></a></a><span> </span><a name="local-1628032814"><a href="#local-1628032814"><span class="hs-identifier">fam_inst_envs</span></a></a><span> </span><a name="local-1628032815"><a href="#local-1628032815"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1628032816"><a href="#local-1628032816"><span class="hs-identifier">tc_args</span></a></a><span>
</span><a name="line-222"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628032817"><a href="#local-1628032817"><span class="hs-identifier">rep_tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628032818"><a href="#local-1628032818"><span class="hs-identifier">rep_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628032819"><a href="#local-1628032819"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcLookupDataFamInst_maybe"><span class="hs-identifier hs-var">tcLookupDataFamInst_maybe</span></a><span> </span><a href="#local-1628032814"><span class="hs-identifier hs-var">fam_inst_envs</span></a><span> </span><a href="#local-1628032815"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628032816"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-224"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1628032817"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032818"><span class="hs-identifier hs-var">rep_args</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032819"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-226"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1628032815"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032816"><span class="hs-identifier hs-var">tc_args</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkRepReflCo"><span class="hs-identifier hs-var">mkRepReflCo</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-1628032815"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628032816"><span class="hs-identifier hs-var">tc_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-identifier">tcLookupDataFamInst_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span>
</span><a name="line-229"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- ^ Converts a data family type (eg F [a]) to its representation type (eg FList a)</span><span>
</span><a name="line-231"></a><span class="hs-comment">-- and returns a coercion between the two: co :: F [a] ~R FList a.</span><span>
</span><a name="line-232"></a><a name="tcLookupDataFamInst_maybe"><a href="FamInst.html#tcLookupDataFamInst_maybe"><span class="hs-identifier">tcLookupDataFamInst_maybe</span></a></a><span> </span><a name="local-1628032820"><a href="#local-1628032820"><span class="hs-identifier">fam_inst_envs</span></a></a><span> </span><a name="local-1628032821"><a href="#local-1628032821"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1628032822"><a href="#local-1628032822"><span class="hs-identifier">tc_args</span></a></a><span>
</span><a name="line-233"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isDataFamilyTyCon"><span class="hs-identifier hs-var">isDataFamilyTyCon</span></a><span> </span><a href="#local-1628032821"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-234"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="local-1628032823"><a href="#local-1628032823"><span class="hs-identifier">match</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#lookupFamInstEnv"><span class="hs-identifier hs-var">lookupFamInstEnv</span></a><span> </span><a href="#local-1628032820"><span class="hs-identifier hs-var">fam_inst_envs</span></a><span> </span><a href="#local-1628032821"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628032822"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-235"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-var">FamInstMatch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fim_instance</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628032824"><a href="#local-1628032824"><span class="hs-identifier">rep_fam</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_axiom</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628032825"><a href="#local-1628032825"><span class="hs-identifier">ax</span></a></a><span>
</span><a name="line-236"></a><span>                                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_cvs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-1628032826"><a href="#local-1628032826"><span class="hs-identifier">cvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fim_tys</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-1628032827"><a href="#local-1628032827"><span class="hs-identifier">rep_args</span></a></a><span>
</span><a name="line-238"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fim_cos</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-1628032828"><a href="#local-1628032828"><span class="hs-identifier">rep_cos</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628032823"><span class="hs-identifier hs-var">match</span></a><span>
</span><a name="line-239"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628032829"><a href="#local-1628032829"><span class="hs-identifier">rep_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#dataFamInstRepTyCon"><span class="hs-identifier hs-var">dataFamInstRepTyCon</span></a><span> </span><a href="#local-1628032824"><span class="hs-identifier hs-var">rep_fam</span></a><span>
</span><a name="line-240"></a><span>        </span><a name="local-1628032830"><a href="#local-1628032830"><span class="hs-identifier">co</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkUnbranchedAxInstCo"><span class="hs-identifier hs-var">mkUnbranchedAxInstCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-1628032825"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-1628032827"><span class="hs-identifier hs-var">rep_args</span></a><span>
</span><a name="line-241"></a><span>                                      </span><span class="hs-special">(</span><a href="Coercion.html#mkCoVarCos"><span class="hs-identifier hs-var">mkCoVarCos</span></a><span> </span><a href="#local-1628032826"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-identifier">rep_cos</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Constrained family instances] in FamInstEnv</span><span>
</span><a name="line-243"></a><span>    </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628032829"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032827"><span class="hs-identifier hs-var">rep_args</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032830"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-246"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span class="hs-comment">-- | 'tcTopNormaliseNewTypeTF_maybe' gets rid of top-level newtypes,</span><span>
</span><a name="line-249"></a><span class="hs-comment">-- potentially looking through newtype instances.</span><span>
</span><a name="line-250"></a><span class="hs-comment">--</span><span>
</span><a name="line-251"></a><span class="hs-comment">-- It is only used by the type inference engine (specifically, when</span><span>
</span><a name="line-252"></a><span class="hs-comment">-- solving representational equality), and hence it is careful to unwrap</span><span>
</span><a name="line-253"></a><span class="hs-comment">-- only if the relevant data constructor is in scope.  That's why</span><span>
</span><a name="line-254"></a><span class="hs-comment">-- it get a GlobalRdrEnv argument.</span><span>
</span><a name="line-255"></a><span class="hs-comment">--</span><span>
</span><a name="line-256"></a><span class="hs-comment">-- It is careful not to unwrap data/newtype instances if it can't</span><span>
</span><a name="line-257"></a><span class="hs-comment">-- continue unwrapping.  Such care is necessary for proper error</span><span>
</span><a name="line-258"></a><span class="hs-comment">-- messages.</span><span>
</span><a name="line-259"></a><span class="hs-comment">--</span><span>
</span><a name="line-260"></a><span class="hs-comment">-- It does not look through type families.</span><span>
</span><a name="line-261"></a><span class="hs-comment">-- It does not normalise arguments to a tycon.</span><span>
</span><a name="line-262"></a><span class="hs-comment">--</span><span>
</span><a name="line-263"></a><span class="hs-comment">-- Always produces a representational coercion.</span><span>
</span><a name="line-264"></a><span class="hs-identifier">tcTopNormaliseNewTypeTF_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span>
</span><a name="line-265"></a><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RdrName.html#GlobalRdrEnv"><span class="hs-identifier hs-type">GlobalRdrEnv</span></a><span>
</span><a name="line-266"></a><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-267"></a><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#TcCoercion"><span class="hs-identifier hs-type">TcCoercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-268"></a><a name="tcTopNormaliseNewTypeTF_maybe"><a href="FamInst.html#tcTopNormaliseNewTypeTF_maybe"><span class="hs-identifier">tcTopNormaliseNewTypeTF_maybe</span></a></a><span> </span><a name="local-1628032831"><a href="#local-1628032831"><span class="hs-identifier">faminsts</span></a></a><span> </span><a name="local-1628032832"><a href="#local-1628032832"><span class="hs-identifier">rdr_env</span></a></a><span> </span><a name="local-1628032833"><a href="#local-1628032833"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-269"></a><span class="hs-comment">-- cf. FamInstEnv.topNormaliseType_maybe and Coercion.topNormaliseNewType_maybe</span><span>
</span><a name="line-270"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#topNormaliseTypeX_maybe"><span class="hs-identifier hs-var">topNormaliseTypeX_maybe</span></a><span> </span><a href="#local-1628032834"><span class="hs-identifier hs-var">stepper</span></a><span> </span><a href="#local-1628032833"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-271"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-272"></a><span>    </span><a name="local-1628032834"><a href="#local-1628032834"><span class="hs-identifier">stepper</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032836"><span class="hs-identifier hs-var">unwrap_newtype</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#composeSteppers"><span class="hs-identifier hs-var">composeSteppers</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628032835"><span class="hs-identifier hs-var">unwrap_newtype_instance</span></a><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span>    </span><span class="hs-comment">-- For newtype instances we take a double step or nothing, so that</span><span>
</span><a name="line-275"></a><span>    </span><span class="hs-comment">-- we don't return the reprsentation type of the newtype instance,</span><span>
</span><a name="line-276"></a><span>    </span><span class="hs-comment">-- which would lead to terrible error messages</span><span>
</span><a name="line-277"></a><span>    </span><a name="local-1628032835"><a href="#local-1628032835"><span class="hs-identifier">unwrap_newtype_instance</span></a></a><span> </span><a name="local-1628032838"><a href="#local-1628032838"><span class="hs-identifier">rec_nts</span></a></a><span> </span><a name="local-1628032839"><a href="#local-1628032839"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1628032840"><a href="#local-1628032840"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-278"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628032841"><a href="#local-1628032841"><span class="hs-identifier">tc'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628032842"><a href="#local-1628032842"><span class="hs-identifier">tys'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628032843"><a href="#local-1628032843"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcLookupDataFamInst_maybe"><span class="hs-identifier hs-var">tcLookupDataFamInst_maybe</span></a><span> </span><a href="#local-1628032831"><span class="hs-identifier hs-var">faminsts</span></a><span> </span><a href="#local-1628032839"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628032840"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-279"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#modifyStepResultCo"><span class="hs-identifier hs-var">modifyStepResultCo</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628032843"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-280"></a><span>        </span><a href="#local-1628032836"><span class="hs-identifier hs-var">unwrap_newtype</span></a><span> </span><a href="#local-1628032838"><span class="hs-identifier hs-var">rec_nts</span></a><span> </span><a href="#local-1628032841"><span class="hs-identifier hs-var">tc'</span></a><span> </span><a href="#local-1628032842"><span class="hs-identifier hs-var">tys'</span></a><span>
</span><a name="line-281"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#NS_Done"><span class="hs-identifier hs-var">NS_Done</span></a><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span>    </span><a name="local-1628032836"><a href="#local-1628032836"><span class="hs-identifier">unwrap_newtype</span></a></a><span> </span><a name="local-1628032844"><a href="#local-1628032844"><span class="hs-identifier">rec_nts</span></a></a><span> </span><a name="local-1628032845"><a href="#local-1628032845"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1628032846"><a href="#local-1628032846"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-284"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628032837"><span class="hs-identifier hs-var">data_cons_in_scope</span></a><span> </span><a href="#local-1628032845"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-285"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#unwrapNewTypeStepper"><span class="hs-identifier hs-var">unwrapNewTypeStepper</span></a><span> </span><a href="#local-1628032844"><span class="hs-identifier hs-var">rec_nts</span></a><span> </span><a href="#local-1628032845"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628032846"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-288"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#NS_Done"><span class="hs-identifier hs-var">NS_Done</span></a><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span>    </span><span class="hs-identifier">data_cons_in_scope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-291"></a><span>    </span><a name="local-1628032837"><a href="#local-1628032837"><span class="hs-identifier">data_cons_in_scope</span></a></a><span> </span><a name="local-1628032847"><a href="#local-1628032847"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-292"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#isWiredInName"><span class="hs-identifier hs-var">isWiredInName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-1628032847"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-293"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#isAbstractTyCon"><span class="hs-identifier hs-var">isAbstractTyCon</span></a><span> </span><a href="#local-1628032847"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="#local-1628032849"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1628032848"><span class="hs-identifier hs-var">data_con_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-295"></a><span>        </span><a name="local-1628032848"><a href="#local-1628032848"><span class="hs-identifier">data_con_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="DataCon.html#dataConName"><span class="hs-identifier hs-var">dataConName</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-1628032847"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>        </span><a name="local-1628032849"><a href="#local-1628032849"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1628032850"><a href="#local-1628032850"><span class="hs-identifier">dc</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="RdrName.html#lookupGRE_Name"><span class="hs-identifier hs-var">lookupGRE_Name</span></a><span> </span><a href="#local-1628032832"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-1628032850"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Extending the family instance environment
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span class="hs-comment">-- Add new locally-defined family instances</span><span>
</span><a name="line-307"></a><span class="hs-identifier">tcExtendLocalFamInstEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628032763"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628032763"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-308"></a><a name="tcExtendLocalFamInstEnv"><a href="FamInst.html#tcExtendLocalFamInstEnv"><span class="hs-identifier">tcExtendLocalFamInstEnv</span></a></a><span> </span><a name="local-1628032851"><a href="#local-1628032851"><span class="hs-identifier">fam_insts</span></a></a><span> </span><a name="local-1628032852"><a href="#local-1628032852"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-309"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628032853"><a href="#local-1628032853"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-310"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628032854"><a href="#local-1628032854"><span class="hs-identifier">inst_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628032855"><a href="#local-1628032855"><span class="hs-identifier">fam_insts'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#foldlM"><span class="hs-identifier hs-var">foldlM</span></a><span> </span><a href="FamInst.html#addLocalFamInst"><span class="hs-identifier hs-var">addLocalFamInst</span></a><span>
</span><a name="line-311"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier">tcg_fam_inst_env</span><span> </span><a href="#local-1628032853"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_fam_insts</span><span> </span><a href="#local-1628032853"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-312"></a><span>                                       </span><a href="#local-1628032851"><span class="hs-identifier hs-var">fam_insts</span></a><span>
</span><a name="line-313"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628032856"><a href="#local-1628032856"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032853"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_fam_insts</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032855"><span class="hs-identifier hs-var">fam_insts'</span></a><span>
</span><a name="line-314"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_fam_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032854"><span class="hs-identifier hs-var">inst_env'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-315"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-1628032856"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-1628032852"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-316"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-comment">-- Check that the proposed new instance is OK,</span><span>
</span><a name="line-319"></a><span class="hs-comment">-- and then add it to the home inst env</span><span>
</span><a name="line-320"></a><span class="hs-comment">-- This must be lazy in the fam_inst arguments, see Note [Lazy axiom match]</span><span>
</span><a name="line-321"></a><span class="hs-comment">-- in FamInstEnv.hs</span><span>
</span><a name="line-322"></a><span class="hs-identifier">addLocalFamInst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span class="hs-special">,</span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-323"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span>
</span><a name="line-324"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-325"></a><a name="addLocalFamInst"><a href="FamInst.html#addLocalFamInst"><span class="hs-identifier">addLocalFamInst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1628032857"><a href="#local-1628032857"><span class="hs-identifier">home_fie</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628032858"><a href="#local-1628032858"><span class="hs-identifier">my_fis</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628032859"><a href="#local-1628032859"><span class="hs-identifier">fam_inst</span></a></a><span>
</span><a name="line-326"></a><span>        </span><span class="hs-comment">-- home_fie includes home package and this module</span><span>
</span><a name="line-327"></a><span>        </span><span class="hs-comment">-- my_fies is just the ones from this module</span><span>
</span><a name="line-328"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;addLocalFamInst&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628032859"><span class="hs-identifier hs-var">fam_inst</span></a><span class="hs-special">)</span><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628032860"><a href="#local-1628032860"><span class="hs-identifier">isGHCi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getIsGHCi"><span class="hs-identifier hs-var">getIsGHCi</span></a><span>
</span><a name="line-331"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628032861"><a href="#local-1628032861"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a><span>
</span><a name="line-332"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;alfi&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628032861"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628032860"><span class="hs-identifier hs-var">isGHCi</span></a><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span>           </span><span class="hs-comment">-- In GHCi, we *override* any identical instances</span><span>
</span><a name="line-335"></a><span>           </span><span class="hs-comment">-- that are also defined in the interactive context</span><span>
</span><a name="line-336"></a><span>           </span><span class="hs-comment">-- See Note [Override identical instances in GHCi] in HscTypes</span><span>
</span><a name="line-337"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628032862"><a href="#local-1628032862"><span class="hs-identifier">home_fie'</span></a></a><span>
</span><a name="line-338"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628032860"><span class="hs-identifier hs-var">isGHCi</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#deleteFromFamInstEnv"><span class="hs-identifier hs-var">deleteFromFamInstEnv</span></a><span> </span><a href="#local-1628032857"><span class="hs-identifier hs-var">home_fie</span></a><span> </span><a href="#local-1628032859"><span class="hs-identifier hs-var">fam_inst</span></a><span>
</span><a name="line-339"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032857"><span class="hs-identifier hs-var">home_fie</span></a><span>
</span><a name="line-340"></a><span>
</span><a name="line-341"></a><span>           </span><span class="hs-comment">-- Load imported instances, so that we report</span><span>
</span><a name="line-342"></a><span>           </span><span class="hs-comment">-- overlaps correctly</span><span>
</span><a name="line-343"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628032863"><a href="#local-1628032863"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEps"><span class="hs-identifier hs-var">getEps</span></a><span>
</span><a name="line-344"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628032864"><a href="#local-1628032864"><span class="hs-identifier">inst_envs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_fam_inst_env</span><span> </span><a href="#local-1628032863"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032862"><span class="hs-identifier hs-var">home_fie'</span></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>             </span><a name="local-1628032865"><a href="#local-1628032865"><span class="hs-identifier">home_fie''</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#extendFamInstEnv"><span class="hs-identifier hs-var">extendFamInstEnv</span></a><span> </span><a href="#local-1628032857"><span class="hs-identifier hs-var">home_fie</span></a><span> </span><a href="#local-1628032859"><span class="hs-identifier hs-var">fam_inst</span></a><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span>           </span><span class="hs-comment">-- Check for conflicting instance decls and injectivity violations</span><span>
</span><a name="line-348"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628032866"><a href="#local-1628032866"><span class="hs-identifier">no_conflict</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#checkForConflicts"><span class="hs-identifier hs-var">checkForConflicts</span></a><span>            </span><a href="#local-1628032864"><span class="hs-identifier hs-var">inst_envs</span></a><span> </span><a href="#local-1628032859"><span class="hs-identifier hs-var">fam_inst</span></a><span>
</span><a name="line-349"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628032867"><a href="#local-1628032867"><span class="hs-identifier">injectivity_ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#checkForInjectivityConflicts"><span class="hs-identifier hs-var">checkForInjectivityConflicts</span></a><span> </span><a href="#local-1628032864"><span class="hs-identifier hs-var">inst_envs</span></a><span> </span><a href="#local-1628032859"><span class="hs-identifier hs-var">fam_inst</span></a><span>
</span><a name="line-350"></a><span>
</span><a name="line-351"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628032866"><span class="hs-identifier hs-var">no_conflict</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1628032867"><span class="hs-identifier hs-var">injectivity_ok</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-352"></a><span>            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628032865"><span class="hs-identifier hs-var">home_fie''</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032859"><span class="hs-identifier hs-var">fam_inst</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1628032858"><span class="hs-identifier hs-var">my_fis</span></a><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span>         </span><span class="hs-keyword">else</span><span>
</span><a name="line-354"></a><span>            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628032857"><span class="hs-identifier hs-var">home_fie</span></a><span class="hs-special">,</span><span>   </span><a href="#local-1628032858"><span class="hs-identifier hs-var">my_fis</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Checking an instance against conflicts with an instance env
*                                                                      *
************************************************************************

Check whether a single family instance conflicts with those in two instance
environments (one for the EPS and one for the HPT).
-}</span><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span class="hs-identifier">checkForConflicts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-368"></a><a name="checkForConflicts"><a href="FamInst.html#checkForConflicts"><span class="hs-identifier">checkForConflicts</span></a></a><span> </span><a name="local-1628032868"><a href="#local-1628032868"><span class="hs-identifier">inst_envs</span></a></a><span> </span><a name="local-1628032869"><a href="#local-1628032869"><span class="hs-identifier">fam_inst</span></a></a><span>
</span><a name="line-369"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628032870"><a href="#local-1628032870"><span class="hs-identifier">conflicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#lookupFamInstEnvConflicts"><span class="hs-identifier hs-var">lookupFamInstEnvConflicts</span></a><span> </span><a href="#local-1628032868"><span class="hs-identifier hs-var">inst_envs</span></a><span> </span><a href="#local-1628032869"><span class="hs-identifier hs-var">fam_inst</span></a><span>
</span><a name="line-370"></a><span>             </span><a name="local-1628032871"><a href="#local-1628032871"><span class="hs-identifier">no_conflicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628032870"><span class="hs-identifier hs-var">conflicts</span></a><span>
</span><a name="line-371"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkForConflicts&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-372"></a><span>         </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-identifier">fim_instance</span><span> </span><a href="#local-1628032870"><span class="hs-identifier hs-var">conflicts</span></a><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628032869"><span class="hs-identifier hs-var">fam_inst</span></a><span>
</span><a name="line-374"></a><span>              </span><span class="hs-comment">-- , ppr inst_envs</span><span>
</span><a name="line-375"></a><span>         </span><span class="hs-special">]</span><span>
</span><a name="line-376"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><a href="#local-1628032871"><span class="hs-identifier hs-var">no_conflicts</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="FamInst.html#conflictInstErr"><span class="hs-identifier hs-var">conflictInstErr</span></a><span> </span><a href="#local-1628032869"><span class="hs-identifier hs-var">fam_inst</span></a><span> </span><a href="#local-1628032870"><span class="hs-identifier hs-var">conflicts</span></a><span>
</span><a name="line-377"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628032871"><span class="hs-identifier hs-var">no_conflicts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span class="hs-comment">-- | Check whether a new open type family equation can be added without</span><span>
</span><a name="line-380"></a><span class="hs-comment">-- violating injectivity annotation supplied by the user. Returns True when</span><span>
</span><a name="line-381"></a><span class="hs-comment">-- this is possible and False if adding this equation would violate injectivity</span><span>
</span><a name="line-382"></a><span class="hs-comment">-- annotation.</span><span>
</span><a name="line-383"></a><span class="hs-identifier">checkForInjectivityConflicts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-384"></a><a name="checkForInjectivityConflicts"><a href="FamInst.html#checkForInjectivityConflicts"><span class="hs-identifier">checkForInjectivityConflicts</span></a></a><span> </span><a name="local-1628032872"><a href="#local-1628032872"><span class="hs-identifier">instEnvs</span></a></a><span> </span><a name="local-1628032873"><a href="#local-1628032873"><span class="hs-identifier">famInst</span></a></a><span>
</span><a name="line-385"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><a href="#local-1628032874"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-386"></a><span>    </span><span class="hs-comment">-- type family is injective in at least one argument</span><span>
</span><a name="line-387"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="TyCon.html#Injective"><span class="hs-identifier hs-var">Injective</span></a><span> </span><a name="local-1628032876"><a href="#local-1628032876"><span class="hs-identifier">inj</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#familyTyConInjectivityInfo"><span class="hs-identifier hs-var">familyTyConInjectivityInfo</span></a><span> </span><a href="#local-1628032874"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-388"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628032877"><a href="#local-1628032877"><span class="hs-identifier">axiom</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a><span> </span><a href="#local-1628032875"><span class="hs-identifier hs-var">fi_ax</span></a><span>
</span><a name="line-389"></a><span>          </span><a name="local-1628032878"><a href="#local-1628032878"><span class="hs-identifier">conflicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#lookupFamInstEnvInjectivityConflicts"><span class="hs-identifier hs-var">lookupFamInstEnvInjectivityConflicts</span></a><span> </span><a href="#local-1628032876"><span class="hs-identifier hs-var">inj</span></a><span> </span><a href="#local-1628032872"><span class="hs-identifier hs-var">instEnvs</span></a><span> </span><a href="#local-1628032873"><span class="hs-identifier hs-var">famInst</span></a><span>
</span><a name="line-390"></a><span>          </span><span class="hs-comment">-- see Note [Verifying injectivity annotation] in FamInstEnv</span><span>
</span><a name="line-391"></a><span>          </span><a name="local-1628032879"><a href="#local-1628032879"><span class="hs-identifier">errs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#makeInjectivityErrors"><span class="hs-identifier hs-var">makeInjectivityErrors</span></a><span> </span><a href="#local-1628032875"><span class="hs-identifier hs-var">fi_ax</span></a><span> </span><a href="#local-1628032877"><span class="hs-identifier hs-var">axiom</span></a><span> </span><a href="#local-1628032876"><span class="hs-identifier hs-var">inj</span></a><span> </span><a href="#local-1628032878"><span class="hs-identifier hs-var">conflicts</span></a><span>
</span><a name="line-392"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-1628032880"><a href="#local-1628032880"><span class="hs-identifier">err</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628032881"><a href="#local-1628032881"><span class="hs-identifier">span</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-1628032881"><span class="hs-identifier hs-var">span</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><a href="#local-1628032880"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628032879"><span class="hs-identifier hs-var">errs</span></a><span>
</span><a name="line-393"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628032879"><span class="hs-identifier hs-var">errs</span></a><span class="hs-special">)</span><span>
</span><a name="line-394"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span>    </span><span class="hs-comment">-- if there was no injectivity annotation or tycon does not represent a</span><span>
</span><a name="line-397"></a><span>    </span><span class="hs-comment">-- type family we report no conflicts</span><span>
</span><a name="line-398"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-399"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-1628032874"><a href="#local-1628032874"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#famInstTyCon"><span class="hs-identifier hs-var">famInstTyCon</span></a><span> </span><a href="#local-1628032873"><span class="hs-identifier hs-var">famInst</span></a><span>
</span><a name="line-400"></a><span>          </span><a name="local-1628032875"><a href="#local-1628032875"><span class="hs-identifier">fi_ax</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fi_axiom</span><span> </span><a href="#local-1628032873"><span class="hs-identifier hs-var">famInst</span></a><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><span class="hs-comment">-- | Build a list of injectivity errors together with their source locations.</span><span>
</span><a name="line-403"></a><span class="hs-identifier">makeInjectivityErrors</span><span>
</span><a name="line-404"></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="#local-1628032762"><span class="hs-identifier hs-type">br</span></a><span>   </span><span class="hs-comment">-- ^ Type family for which we generate errors</span><span>
</span><a name="line-405"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span>   </span><span class="hs-comment">-- ^ Currently checked equation (represented by axiom)</span><span>
</span><a name="line-406"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- ^ Injectivity annotation</span><span>
</span><a name="line-407"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ List of injectivity conflicts</span><span>
</span><a name="line-408"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">,</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-409"></a><a name="makeInjectivityErrors"><a href="FamInst.html#makeInjectivityErrors"><span class="hs-identifier">makeInjectivityErrors</span></a></a><span> </span><a name="local-1628032882"><a href="#local-1628032882"><span class="hs-identifier">fi_ax</span></a></a><span> </span><a name="local-1628032883"><a href="#local-1628032883"><span class="hs-identifier">axiom</span></a></a><span> </span><a name="local-1628032884"><a href="#local-1628032884"><span class="hs-identifier">inj</span></a></a><span> </span><a name="local-1628032885"><a href="#local-1628032885"><span class="hs-identifier">conflicts</span></a></a><span>
</span><a name="line-410"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">any</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-identifier hs-var">inj</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;No injective type variables&quot;</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1628032886"><a href="#local-1628032886"><span class="hs-identifier">lhs</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchLHS"><span class="hs-identifier hs-var">coAxBranchLHS</span></a><span> </span><a href="#local-1628032883"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-412"></a><span>        </span><a name="local-1628032887"><a href="#local-1628032887"><span class="hs-identifier">rhs</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchRHS"><span class="hs-identifier hs-var">coAxBranchRHS</span></a><span> </span><a href="#local-1628032883"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-413"></a><span>
</span><a name="line-414"></a><span>        </span><a name="local-1628032888"><a href="#local-1628032888"><span class="hs-identifier">are_conflicts</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628032885"><span class="hs-identifier hs-var">conflicts</span></a><span>
</span><a name="line-415"></a><span>        </span><a name="local-1628032889"><a href="#local-1628032889"><span class="hs-identifier">unused_inj_tvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#unusedInjTvsInRHS"><span class="hs-identifier hs-var">unusedInjTvsInRHS</span></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxiomTyCon"><span class="hs-identifier hs-var">coAxiomTyCon</span></a><span> </span><a href="#local-1628032882"><span class="hs-identifier hs-var">fi_ax</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628032884"><span class="hs-identifier hs-var">inj</span></a><span> </span><a href="#local-1628032886"><span class="hs-identifier hs-var">lhs</span></a><span> </span><a href="#local-1628032887"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-416"></a><span>        </span><a name="local-1628032890"><a href="#local-1628032890"><span class="hs-identifier">inj_tvs_unused</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#and"><span class="hs-identifier hs-var">and</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="#local-1628032889"><span class="hs-identifier hs-var">unused_inj_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-417"></a><span>        </span><a name="local-1628032891"><a href="#local-1628032891"><span class="hs-identifier">tf_headed</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#isTFHeaded"><span class="hs-identifier hs-var">isTFHeaded</span></a><span> </span><a href="#local-1628032887"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-418"></a><span>        </span><a name="local-1628032892"><a href="#local-1628032892"><span class="hs-identifier">bare_variables</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#bareTvInRHSViolated"><span class="hs-identifier hs-var">bareTvInRHSViolated</span></a><span> </span><a href="#local-1628032886"><span class="hs-identifier hs-var">lhs</span></a><span> </span><a href="#local-1628032887"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-419"></a><span>        </span><a name="local-1628032893"><a href="#local-1628032893"><span class="hs-identifier">wrong_bare_rhs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628032892"><span class="hs-identifier hs-var">bare_variables</span></a><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span>        </span><a name="local-1628032894"><a href="#local-1628032894"><span class="hs-identifier">err_builder</span></a></a><span> </span><a name="local-1628032896"><a href="#local-1628032896"><span class="hs-identifier">herald</span></a></a><span> </span><a name="local-1628032897"><a href="#local-1628032897"><span class="hs-identifier">eqns</span></a></a><span>
</span><a name="line-422"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><a href="#local-1628032896"><span class="hs-identifier hs-var">herald</span></a><span>
</span><a name="line-423"></a><span>                               </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#pprCoAxBranch"><span class="hs-identifier hs-var">pprCoAxBranch</span></a><span> </span><a href="#local-1628032882"><span class="hs-identifier hs-var">fi_ax</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628032897"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>                          </span><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#coAxBranchSpan"><span class="hs-identifier hs-var">coAxBranchSpan</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#head"><span class="hs-identifier hs-var">head</span></a><span> </span><a href="#local-1628032897"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-425"></a><span>        </span><a name="local-1628032895"><a href="#local-1628032895"><span class="hs-identifier">errorIf</span></a></a><span> </span><a name="local-1628032898"><a href="#local-1628032898"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-1628032899"><a href="#local-1628032899"><span class="hs-identifier">f</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628032898"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><a href="#local-1628032899"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1628032894"><span class="hs-identifier hs-var">err_builder</span></a><span> </span><a href="#local-1628032883"><span class="hs-identifier hs-var">axiom</span></a><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-426"></a><span>     </span><span class="hs-keyword">in</span><span>    </span><a href="#local-1628032895"><span class="hs-identifier hs-var">errorIf</span></a><span> </span><a href="#local-1628032888"><span class="hs-identifier hs-var">are_conflicts</span></a><span>  </span><span class="hs-special">(</span><a href="FamInst.html#conflictInjInstErr"><span class="hs-identifier hs-var">conflictInjInstErr</span></a><span>     </span><a href="#local-1628032885"><span class="hs-identifier hs-var">conflicts</span></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-427"></a><span>        </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628032895"><span class="hs-identifier hs-var">errorIf</span></a><span> </span><a href="#local-1628032890"><span class="hs-identifier hs-var">inj_tvs_unused</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#unusedInjectiveVarsErr"><span class="hs-identifier hs-var">unusedInjectiveVarsErr</span></a><span> </span><a href="#local-1628032889"><span class="hs-identifier hs-var">unused_inj_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span>        </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628032895"><span class="hs-identifier hs-var">errorIf</span></a><span> </span><a href="#local-1628032891"><span class="hs-identifier hs-var">tf_headed</span></a><span>       </span><a href="FamInst.html#tfHeadedErr"><span class="hs-identifier hs-var">tfHeadedErr</span></a><span>
</span><a name="line-429"></a><span>        </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628032895"><span class="hs-identifier hs-var">errorIf</span></a><span> </span><a href="#local-1628032893"><span class="hs-identifier hs-var">wrong_bare_rhs</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#bareVariableInRHSErr"><span class="hs-identifier hs-var">bareVariableInRHSErr</span></a><span>   </span><a href="#local-1628032892"><span class="hs-identifier hs-var">bare_variables</span></a><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span class="hs-comment">-- | Return a list of type variables that the function is injective in and that</span><span>
</span><a name="line-433"></a><span class="hs-comment">-- do not appear on injective positions in the RHS of a family instance</span><span>
</span><a name="line-434"></a><span class="hs-comment">-- declaration. The returned Pair includes invisible vars followed by visible ones</span><span>
</span><a name="line-435"></a><span class="hs-identifier">unusedInjTvsInRHS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="VarSet.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a><span>
</span><a name="line-436"></a><span class="hs-comment">-- INVARIANT: [Bool] list contains at least one True value</span><span>
</span><a name="line-437"></a><span class="hs-comment">-- See Note [Verifying injectivity annotation]. This function implements fourth</span><span>
</span><a name="line-438"></a><span class="hs-comment">-- check described there.</span><span>
</span><a name="line-439"></a><span class="hs-comment">-- In theory, instead of implementing this whole check in this way, we could</span><span>
</span><a name="line-440"></a><span class="hs-comment">-- attempt to unify equation with itself.  We would reject exactly the same</span><span>
</span><a name="line-441"></a><span class="hs-comment">-- equations but this method gives us more precise error messages by returning</span><span>
</span><a name="line-442"></a><span class="hs-comment">-- precise names of variables that are not mentioned in the RHS.</span><span>
</span><a name="line-443"></a><a name="unusedInjTvsInRHS"><a href="FamInst.html#unusedInjTvsInRHS"><span class="hs-identifier">unusedInjTvsInRHS</span></a></a><span> </span><a name="local-1628032900"><a href="#local-1628032900"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-1628032901"><a href="#local-1628032901"><span class="hs-identifier">injList</span></a></a><span> </span><a name="local-1628032902"><a href="#local-1628032902"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-1628032903"><a href="#local-1628032903"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-444"></a><span>  </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#minusVarSet"><span class="hs-identifier hs-var">minusVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628032912"><span class="hs-identifier hs-var">injRhsVars</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="#local-1628032911"><span class="hs-identifier hs-var">injLHSVars</span></a><span>
</span><a name="line-445"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-446"></a><span>      </span><span class="hs-comment">-- set of type and kind variables in which type family is injective</span><span>
</span><a name="line-447"></a><span>      </span><span class="hs-special">(</span><a name="local-1628032904"><a href="#local-1628032904"><span class="hs-identifier">invis_pairs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628032905"><a href="#local-1628032905"><span class="hs-identifier">vis_pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-448"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#partitionInvisibles"><span class="hs-identifier hs-var">partitionInvisibles</span></a><span> </span><a href="#local-1628032900"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><span class="hs-special">(</span><a href="Util.html#zipEqual"><span class="hs-identifier hs-var">zipEqual</span></a><span> </span><span class="hs-string">&quot;unusedInjTvsInRHS&quot;</span><span> </span><a href="#local-1628032901"><span class="hs-identifier hs-var">injList</span></a><span> </span><a href="#local-1628032902"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-449"></a><span>      </span><a name="local-1628032906"><a href="#local-1628032906"><span class="hs-identifier">invis_lhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#uncurry"><span class="hs-identifier hs-var">uncurry</span></a><span> </span><a href="Util.html#filterByList"><span class="hs-identifier hs-var">filterByList</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="#local-1628032904"><span class="hs-identifier hs-var">invis_pairs</span></a><span>
</span><a name="line-450"></a><span>      </span><a name="local-1628032907"><a href="#local-1628032907"><span class="hs-identifier">vis_lhs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#uncurry"><span class="hs-identifier hs-var">uncurry</span></a><span> </span><a href="Util.html#filterByList"><span class="hs-identifier hs-var">filterByList</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="#local-1628032905"><span class="hs-identifier hs-var">vis_pairs</span></a><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span>      </span><a name="local-1628032908"><a href="#local-1628032908"><span class="hs-identifier">invis_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><a href="#local-1628032906"><span class="hs-identifier hs-var">invis_lhs</span></a><span>
</span><a name="line-453"></a><span>      </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1628032909"><a href="#local-1628032909"><span class="hs-identifier">invis_vars'</span></a></a><span> </span><a name="local-1628032910"><a href="#local-1628032910"><span class="hs-identifier">vis_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#splitVisVarsOfTypes"><span class="hs-identifier hs-var">splitVisVarsOfTypes</span></a><span> </span><a href="#local-1628032907"><span class="hs-identifier hs-var">vis_lhs</span></a><span>
</span><a name="line-454"></a><span>      </span><a name="local-1628032911"><a href="#local-1628032911"><span class="hs-identifier">injLHSVars</span></a></a><span>
</span><a name="line-455"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628032908"><span class="hs-identifier hs-var">invis_vars</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#minusVarSet"><span class="hs-identifier hs-var">minusVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628032910"><span class="hs-identifier hs-var">vis_vars</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628032909"><span class="hs-identifier hs-var">invis_vars'</span></a><span class="hs-special">)</span><span>
</span><a name="line-456"></a><span>               </span><a href="#local-1628032910"><span class="hs-identifier hs-var">vis_vars</span></a><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span>      </span><span class="hs-comment">-- set of type variables appearing in the RHS on an injective position.</span><span>
</span><a name="line-459"></a><span>      </span><span class="hs-comment">-- For all returned variables we assume their associated kind variables</span><span>
</span><a name="line-460"></a><span>      </span><span class="hs-comment">-- also appear in the RHS.</span><span>
</span><a name="line-461"></a><span>      </span><a name="local-1628032912"><a href="#local-1628032912"><span class="hs-identifier">injRhsVars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032913"><span class="hs-identifier hs-var">collectInjVars</span></a><span> </span><a href="#local-1628032903"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><span>      </span><span class="hs-comment">-- Collect all type variables that are either arguments to a type</span><span>
</span><a name="line-464"></a><span>      </span><span class="hs-comment">-- constructor or to injective type families.</span><span>
</span><a name="line-465"></a><span>      </span><span class="hs-identifier">collectInjVars</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-466"></a><span>      </span><a name="local-1628032913"><a href="#local-1628032913"><span class="hs-identifier">collectInjVars</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-1628032915"><a href="#local-1628032915"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-467"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#unitVarSet"><span class="hs-identifier hs-var">unitVarSet</span></a><span> </span><a href="#local-1628032915"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628032913"><span class="hs-identifier hs-var">collectInjVars</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-1628032915"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-468"></a><span>      </span><span class="hs-identifier">collectInjVars</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-1628032916"><a href="#local-1628032916"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1628032917"><a href="#local-1628032917"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><a href="#local-1628032916"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032914"><span class="hs-identifier hs-var">collectInjTFVars</span></a><span> </span><a href="#local-1628032917"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-470"></a><span>                                                 </span><span class="hs-special">(</span><a href="TyCon.html#familyTyConInjectivityInfo"><span class="hs-identifier hs-var">familyTyConInjectivityInfo</span></a><span> </span><a href="#local-1628032916"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-471"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mapUnionVarSet"><span class="hs-identifier hs-var">mapUnionVarSet</span></a><span> </span><a href="#local-1628032913"><span class="hs-identifier hs-var">collectInjVars</span></a><span> </span><a href="#local-1628032917"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-472"></a><span>      </span><span class="hs-identifier">collectInjVars</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LitTy"><span class="hs-identifier hs-var">LitTy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span>
</span><a name="line-474"></a><span>      </span><span class="hs-identifier">collectInjVars</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Anon"><span class="hs-identifier hs-var">Anon</span></a><span> </span><a name="local-1628032918"><a href="#local-1628032918"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628032919"><a href="#local-1628032919"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-475"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032913"><span class="hs-identifier hs-var">collectInjVars</span></a><span> </span><a href="#local-1628032918"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628032913"><span class="hs-identifier hs-var">collectInjVars</span></a><span> </span><a href="#local-1628032919"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-476"></a><span>      </span><span class="hs-identifier">collectInjVars</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-1628032920"><a href="#local-1628032920"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-1628032921"><a href="#local-1628032921"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-477"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032913"><span class="hs-identifier hs-var">collectInjVars</span></a><span> </span><a href="#local-1628032920"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628032913"><span class="hs-identifier hs-var">collectInjVars</span></a><span> </span><a href="#local-1628032921"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-478"></a><span>      </span><span class="hs-comment">-- no forall types in the RHS of a type family</span><span>
</span><a name="line-479"></a><span>      </span><span class="hs-identifier">collectInjVars</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span>
</span><a name="line-480"></a><span>          </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;unusedInjTvsInRHS.collectInjVars&quot;</span><span>
</span><a name="line-481"></a><span>      </span><span class="hs-identifier">collectInjVars</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-1628032922"><a href="#local-1628032922"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032913"><span class="hs-identifier hs-var">collectInjVars</span></a><span> </span><a href="#local-1628032922"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-482"></a><span>      </span><span class="hs-identifier">collectInjVars</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span>      </span><span class="hs-identifier">collectInjTFVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#Injectivity"><span class="hs-identifier hs-type">Injectivity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-485"></a><span>      </span><a name="local-1628032914"><a href="#local-1628032914"><span class="hs-identifier">collectInjTFVars</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="TyCon.html#NotInjective"><span class="hs-identifier hs-var">NotInjective</span></a><span>
</span><a name="line-486"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span>
</span><a name="line-487"></a><span>      </span><span class="hs-identifier">collectInjTFVars</span><span> </span><a name="local-1628032923"><a href="#local-1628032923"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#Injective"><span class="hs-identifier hs-var">Injective</span></a><span> </span><a name="local-1628032924"><a href="#local-1628032924"><span class="hs-identifier">injList</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-488"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mapUnionVarSet"><span class="hs-identifier hs-var">mapUnionVarSet</span></a><span> </span><a href="#local-1628032913"><span class="hs-identifier hs-var">collectInjVars</span></a><span> </span><span class="hs-special">(</span><a href="Util.html#filterByList"><span class="hs-identifier hs-var">filterByList</span></a><span> </span><a href="#local-1628032924"><span class="hs-identifier hs-var">injList</span></a><span> </span><a href="#local-1628032923"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-comment">-- | Is type headed by a type family application?</span><span>
</span><a name="line-492"></a><span class="hs-identifier">isTFHeaded</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-493"></a><span class="hs-comment">-- See Note [Verifying injectivity annotation]. This function implements third</span><span>
</span><a name="line-494"></a><span class="hs-comment">-- check described there.</span><span>
</span><a name="line-495"></a><a name="isTFHeaded"><a href="FamInst.html#isTFHeaded"><span class="hs-identifier">isTFHeaded</span></a></a><span> </span><a name="local-1628032925"><a href="#local-1628032925"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628032926"><a href="#local-1628032926"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-1628032925"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-496"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#isTFHeaded"><span class="hs-identifier hs-var">isTFHeaded</span></a><span> </span><a href="#local-1628032926"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-497"></a><span class="hs-identifier">isTFHeaded</span><span> </span><a name="local-1628032927"><a href="#local-1628032927"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-1628032928"><a href="#local-1628032928"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1628032929"><a href="#local-1628032929"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628032927"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-498"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><a href="#local-1628032928"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-499"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-1628032928"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1628032929"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-500"></a><span class="hs-identifier">isTFHeaded</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-501"></a><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span class="hs-comment">-- | If a RHS is a bare type variable return a set of LHS patterns that are not</span><span>
</span><a name="line-504"></a><span class="hs-comment">-- bare type variables.</span><span>
</span><a name="line-505"></a><span class="hs-identifier">bareTvInRHSViolated</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-506"></a><span class="hs-comment">-- See Note [Verifying injectivity annotation]. This function implements second</span><span>
</span><a name="line-507"></a><span class="hs-comment">-- check described there.</span><span>
</span><a name="line-508"></a><a name="bareTvInRHSViolated"><a href="FamInst.html#bareTvInRHSViolated"><span class="hs-identifier">bareTvInRHSViolated</span></a></a><span> </span><a name="local-1628032930"><a href="#local-1628032930"><span class="hs-identifier">pats</span></a></a><span> </span><a name="local-1628032931"><a href="#local-1628032931"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isTyVarTy"><span class="hs-identifier hs-var">isTyVarTy</span></a><span> </span><a href="#local-1628032931"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-509"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="Type.html#isTyVarTy"><span class="hs-identifier hs-var">isTyVarTy</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628032930"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-510"></a><span class="hs-identifier">bareTvInRHSViolated</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span>
</span><a name="line-513"></a><span class="hs-identifier">conflictInstErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-type">FamInstMatch</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcRn"><span class="hs-identifier hs-type">TcRn</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-514"></a><a name="conflictInstErr"><a href="FamInst.html#conflictInstErr"><span class="hs-identifier">conflictInstErr</span></a></a><span> </span><a name="local-1628032932"><a href="#local-1628032932"><span class="hs-identifier">fam_inst</span></a></a><span> </span><a name="local-1628032933"><a href="#local-1628032933"><span class="hs-identifier">conflictingMatch</span></a></a><span>
</span><a name="line-515"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-var">FamInstMatch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fim_instance</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628032934"><a href="#local-1628032934"><span class="hs-identifier">confInst</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628032933"><span class="hs-identifier hs-var">conflictingMatch</span></a><span>
</span><a name="line-516"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628032935"><a href="#local-1628032935"><span class="hs-identifier">err</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628032936"><a href="#local-1628032936"><span class="hs-identifier">span</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#makeFamInstsErr"><span class="hs-identifier hs-var">makeFamInstsErr</span></a><span>
</span><a name="line-517"></a><span>                            </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Conflicting family instance declarations:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-518"></a><span>                            </span><span class="hs-special">[</span><a href="#local-1628032932"><span class="hs-identifier hs-var">fam_inst</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032934"><span class="hs-identifier hs-var">confInst</span></a><span class="hs-special">]</span><span>
</span><a name="line-519"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-1628032936"><span class="hs-identifier hs-var">span</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><a href="#local-1628032935"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-520"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-521"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;conflictInstErr&quot;</span><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span class="hs-comment">-- | Type of functions that use error message and a list of axioms to build full</span><span>
</span><a name="line-524"></a><span class="hs-comment">-- error message (with a source location) for injective type families.</span><span>
</span><a name="line-525"></a><span class="hs-keyword">type</span><span> </span><a name="InjErrorBuilder"><a href="FamInst.html#InjErrorBuilder"><span class="hs-identifier">InjErrorBuilder</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">,</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span class="hs-comment">-- | Build injecivity error herald common to all injectivity errors.</span><span>
</span><a name="line-528"></a><span class="hs-identifier">injectivityErrorHerald</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-529"></a><a name="injectivityErrorHerald"><a href="FamInst.html#injectivityErrorHerald"><span class="hs-identifier">injectivityErrorHerald</span></a></a><span> </span><a name="local-1628032937"><a href="#local-1628032937"><span class="hs-identifier">isSingular</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-530"></a><span>  </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Type family equation&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="#local-1628032938"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-1628032937"><span class="hs-identifier hs-var">isSingular</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;violate&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span>
</span><a name="line-531"></a><span>  </span><a href="#local-1628032938"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1628032937"><span class="hs-identifier hs-var">isSingular</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;injectivity annotation&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span>
</span><a name="line-532"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628032937"><span class="hs-identifier hs-var">isSingular</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="Outputable.html#dot"><span class="hs-identifier hs-var">dot</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a><span>
</span><a name="line-533"></a><span>  </span><span class="hs-comment">-- Above is an ugly hack.  We want this: &quot;sentence. herald:&quot; (note the dot and</span><span>
</span><a name="line-534"></a><span>  </span><span class="hs-comment">-- colon).  But if herald is empty we want &quot;sentence:&quot; (note the colon).  We</span><span>
</span><a name="line-535"></a><span>  </span><span class="hs-comment">-- can't test herald for emptiness so we rely on the fact that herald is empty</span><span>
</span><a name="line-536"></a><span>  </span><span class="hs-comment">-- only when isSingular is False.  If herald is non empty it must end with a</span><span>
</span><a name="line-537"></a><span>  </span><span class="hs-comment">-- colon.</span><span>
</span><a name="line-538"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-539"></a><span>      </span><a name="local-1628032938"><a href="#local-1628032938"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;s&quot;</span><span>
</span><a name="line-540"></a><span>      </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span class="hs-comment">-- | Build error message for a pair of equations violating an injectivity</span><span>
</span><a name="line-543"></a><span class="hs-comment">-- annotation.</span><span>
</span><a name="line-544"></a><span class="hs-identifier">conflictInjInstErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInst.html#InjErrorBuilder"><span class="hs-identifier hs-type">InjErrorBuilder</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span>
</span><a name="line-545"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">,</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span class="hs-special">)</span><span>
</span><a name="line-546"></a><a name="conflictInjInstErr"><a href="FamInst.html#conflictInjInstErr"><span class="hs-identifier">conflictInjInstErr</span></a></a><span> </span><a name="local-1628032939"><a href="#local-1628032939"><span class="hs-identifier">conflictingEqns</span></a></a><span> </span><a name="local-1628032940"><a href="#local-1628032940"><span class="hs-identifier">errorBuilder</span></a></a><span> </span><a name="local-1628032941"><a href="#local-1628032941"><span class="hs-identifier">tyfamEqn</span></a></a><span>
</span><a name="line-547"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="local-1628032942"><a href="#local-1628032942"><span class="hs-identifier">confEqn</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628032939"><span class="hs-identifier hs-var">conflictingEqns</span></a><span>
</span><a name="line-548"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032940"><span class="hs-identifier hs-var">errorBuilder</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#injectivityErrorHerald"><span class="hs-identifier hs-var">injectivityErrorHerald</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-1628032942"><span class="hs-identifier hs-var">confEqn</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032941"><span class="hs-identifier hs-var">tyfamEqn</span></a><span class="hs-special">]</span><span>
</span><a name="line-549"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-550"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;conflictInjInstErr&quot;</span><span>
</span><a name="line-551"></a><span>
</span><a name="line-552"></a><span class="hs-comment">-- | Build error message for equation with injective type variables unused in</span><span>
</span><a name="line-553"></a><span class="hs-comment">-- the RHS.</span><span>
</span><a name="line-554"></a><span class="hs-identifier">unusedInjectiveVarsErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="VarSet.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInst.html#InjErrorBuilder"><span class="hs-identifier hs-type">InjErrorBuilder</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span>
</span><a name="line-555"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">,</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span class="hs-special">)</span><span>
</span><a name="line-556"></a><a name="unusedInjectiveVarsErr"><a href="FamInst.html#unusedInjectiveVarsErr"><span class="hs-identifier">unusedInjectiveVarsErr</span></a></a><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1628032943"><a href="#local-1628032943"><span class="hs-identifier">invis_vars</span></a></a><span> </span><a name="local-1628032944"><a href="#local-1628032944"><span class="hs-identifier">vis_vars</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628032945"><a href="#local-1628032945"><span class="hs-identifier">errorBuilder</span></a></a><span> </span><a name="local-1628032946"><a href="#local-1628032946"><span class="hs-identifier">tyfamEqn</span></a></a><span>
</span><a name="line-557"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032945"><span class="hs-identifier hs-var">errorBuilder</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#injectivityErrorHerald"><span class="hs-identifier hs-var">injectivityErrorHerald</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="#local-1628032953"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-558"></a><span>                 </span><span class="hs-special">[</span><a href="#local-1628032946"><span class="hs-identifier hs-var">tyfamEqn</span></a><span class="hs-special">]</span><span>
</span><a name="line-559"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-560"></a><span>      </span><a name="local-1628032947"><a href="#local-1628032947"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#varSetElemsWellScoped"><span class="hs-identifier hs-var">varSetElemsWellScoped</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628032943"><span class="hs-identifier hs-var">invis_vars</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628032944"><span class="hs-identifier hs-var">vis_vars</span></a><span class="hs-special">)</span><span>
</span><a name="line-561"></a><span>      </span><a name="local-1628032948"><a href="#local-1628032948"><span class="hs-identifier">has_types</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="VarSet.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a><span> </span><a href="#local-1628032944"><span class="hs-identifier hs-var">vis_vars</span></a><span>
</span><a name="line-562"></a><span>      </span><a name="local-1628032949"><a href="#local-1628032949"><span class="hs-identifier">has_kinds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="VarSet.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a><span> </span><a href="#local-1628032943"><span class="hs-identifier hs-var">invis_vars</span></a><span>
</span><a name="line-563"></a><span>
</span><a name="line-564"></a><span>      </span><a name="local-1628032950"><a href="#local-1628032950"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1628032951"><span class="hs-identifier hs-var">what</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;variable&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span>
</span><a name="line-565"></a><span>                  </span><a href="Outputable.html#plural"><span class="hs-identifier hs-var">plural</span></a><span> </span><a href="#local-1628032947"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#pprQuotedList"><span class="hs-identifier hs-var">pprQuotedList</span></a><span> </span><a href="#local-1628032947"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-566"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;cannot be inferred from the right-hand side.&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-567"></a><span>      </span><a name="local-1628032951"><a href="#local-1628032951"><span class="hs-identifier">what</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-1628032948"><span class="hs-identifier hs-var">has_types</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628032949"><span class="hs-identifier hs-var">has_kinds</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-568"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Type and kind&quot;</span><span>
</span><a name="line-569"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Type&quot;</span><span>
</span><a name="line-570"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Kind&quot;</span><span>
</span><a name="line-571"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;mkUnusedInjectiveVarsErr&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628032947"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-572"></a><span>      </span><a name="local-1628032952"><a href="#local-1628032952"><span class="hs-identifier">print_kinds_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sdocWithDynFlags"><span class="hs-identifier hs-var">sdocWithDynFlags</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-1628032954"><a href="#local-1628032954"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-573"></a><span>                         </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628032949"><span class="hs-identifier hs-var">has_kinds</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_PrintExplicitKinds"><span class="hs-identifier hs-var">Opt_PrintExplicitKinds</span></a><span> </span><a href="#local-1628032954"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-574"></a><span>                         </span><span class="hs-keyword">then</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;(enabling -fprint-explicit-kinds might help)&quot;</span><span>
</span><a name="line-575"></a><span>                         </span><span class="hs-keyword">else</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-576"></a><span>      </span><a name="local-1628032953"><a href="#local-1628032953"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032950"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="#local-1628032952"><span class="hs-identifier hs-var">print_kinds_info</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-577"></a><span>            </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;In the type family equation:&quot;</span><span>
</span><a name="line-578"></a><span>
</span><a name="line-579"></a><span class="hs-comment">-- | Build error message for equation that has a type family call at the top</span><span>
</span><a name="line-580"></a><span class="hs-comment">-- level of RHS</span><span>
</span><a name="line-581"></a><span class="hs-identifier">tfHeadedErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInst.html#InjErrorBuilder"><span class="hs-identifier hs-type">InjErrorBuilder</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span>
</span><a name="line-582"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">,</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span class="hs-special">)</span><span>
</span><a name="line-583"></a><a name="tfHeadedErr"><a href="FamInst.html#tfHeadedErr"><span class="hs-identifier">tfHeadedErr</span></a></a><span> </span><a name="local-1628032955"><a href="#local-1628032955"><span class="hs-identifier">errorBuilder</span></a></a><span> </span><a name="local-1628032956"><a href="#local-1628032956"><span class="hs-identifier">famInst</span></a></a><span>
</span><a name="line-584"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032955"><span class="hs-identifier hs-var">errorBuilder</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#injectivityErrorHerald"><span class="hs-identifier hs-var">injectivityErrorHerald</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-585"></a><span>                  </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;RHS of injective type family equation cannot&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-586"></a><span>                  </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;be a type family:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-1628032956"><span class="hs-identifier hs-var">famInst</span></a><span class="hs-special">]</span><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span class="hs-comment">-- | Build error message for equation that has a bare type variable in the RHS</span><span>
</span><a name="line-589"></a><span class="hs-comment">-- but LHS pattern is not a bare type variable.</span><span>
</span><a name="line-590"></a><span class="hs-identifier">bareVariableInRHSErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInst.html#InjErrorBuilder"><span class="hs-identifier hs-type">InjErrorBuilder</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span>
</span><a name="line-591"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">,</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span class="hs-special">)</span><span>
</span><a name="line-592"></a><a name="bareVariableInRHSErr"><a href="FamInst.html#bareVariableInRHSErr"><span class="hs-identifier">bareVariableInRHSErr</span></a></a><span> </span><a name="local-1628032957"><a href="#local-1628032957"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-1628032958"><a href="#local-1628032958"><span class="hs-identifier">errorBuilder</span></a></a><span> </span><a name="local-1628032959"><a href="#local-1628032959"><span class="hs-identifier">famInst</span></a></a><span>
</span><a name="line-593"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628032958"><span class="hs-identifier hs-var">errorBuilder</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#injectivityErrorHerald"><span class="hs-identifier hs-var">injectivityErrorHerald</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-594"></a><span>                  </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;RHS of injective type family equation is a bare&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-595"></a><span>                  </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;type variable&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-596"></a><span>                  </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;but these LHS type and kind patterns are not bare&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-597"></a><span>                  </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;variables:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#pprQuotedList"><span class="hs-identifier hs-var">pprQuotedList</span></a><span> </span><a href="#local-1628032957"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-1628032959"><span class="hs-identifier hs-var">famInst</span></a><span class="hs-special">]</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span>
</span><a name="line-600"></a><span class="hs-identifier">makeFamInstsErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">,</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span class="hs-special">)</span><span>
</span><a name="line-601"></a><a name="makeFamInstsErr"><a href="FamInst.html#makeFamInstsErr"><span class="hs-identifier">makeFamInstsErr</span></a></a><span> </span><a name="local-1628032960"><a href="#local-1628032960"><span class="hs-identifier">herald</span></a></a><span> </span><a name="local-1628032961"><a href="#local-1628032961"><span class="hs-identifier">insts</span></a></a><span>
</span><a name="line-602"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">insts</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-603"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><a href="#local-1628032960"><span class="hs-identifier hs-var">herald</span></a><span>
</span><a name="line-604"></a><span>         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Coercion.html#pprCoAxBranchHdr"><span class="hs-identifier hs-var">pprCoAxBranchHdr</span></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#famInstAxiom"><span class="hs-identifier hs-var">famInstAxiom</span></a><span> </span><a href="#local-1628032966"><span class="hs-identifier hs-var">fi</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-605"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="local-1628032966"><a href="#local-1628032966"><span class="hs-identifier">fi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628032963"><span class="hs-identifier hs-var">sorted</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-606"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="#local-1628032965"><span class="hs-identifier hs-var">srcSpan</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-607"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-608"></a><span>   </span><a name="local-1628032962"><a href="#local-1628032962"><span class="hs-identifier">getSpan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#getSrcLoc"><span class="hs-identifier hs-var">getSrcLoc</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="FamInstEnv.html#famInstAxiom"><span class="hs-identifier hs-var">famInstAxiom</span></a><span>
</span><a name="line-609"></a><span>   </span><a name="local-1628032963"><a href="#local-1628032963"><span class="hs-identifier">sorted</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Exts.html#sortWith"><span class="hs-identifier hs-var">sortWith</span></a><span> </span><a href="#local-1628032962"><span class="hs-identifier hs-var">getSpan</span></a><span> </span><a href="#local-1628032961"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-610"></a><span>   </span><a name="local-1628032964"><a href="#local-1628032964"><span class="hs-identifier">fi1</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#head"><span class="hs-identifier hs-var">head</span></a><span> </span><a href="#local-1628032963"><span class="hs-identifier hs-var">sorted</span></a><span>
</span><a name="line-611"></a><span>   </span><a name="local-1628032965"><a href="#local-1628032965"><span class="hs-identifier">srcSpan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchSpan"><span class="hs-identifier hs-var">coAxBranchSpan</span></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#famInstAxiom"><span class="hs-identifier hs-var">famInstAxiom</span></a><span> </span><a href="#local-1628032964"><span class="hs-identifier hs-var">fi1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-612"></a><span>   </span><span class="hs-comment">-- The sortWith just arranges that instances are dislayed in order</span><span>
</span><a name="line-613"></a><span>   </span><span class="hs-comment">-- of source location, which reduced wobbling in error messages,</span><span>
</span><a name="line-614"></a><span>   </span><span class="hs-comment">-- and is better for users</span><span>
</span><a name="line-615"></a><span>
</span><a name="line-616"></a><span class="hs-identifier">tcGetFamInstEnvs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span>
</span><a name="line-617"></a><span class="hs-comment">-- Gets both the external-package inst-env</span><span>
</span><a name="line-618"></a><span class="hs-comment">-- and the home-pkg inst env (includes module being compiled)</span><span>
</span><a name="line-619"></a><a name="tcGetFamInstEnvs"><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier">tcGetFamInstEnvs</span></a></a><span>
</span><a name="line-620"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628032967"><a href="#local-1628032967"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEps"><span class="hs-identifier hs-var">getEps</span></a><span class="hs-special">;</span><span> </span><a name="local-1628032968"><a href="#local-1628032968"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-621"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_fam_inst_env</span><span> </span><a href="#local-1628032967"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_fam_inst_env</span><span> </span><a href="#local-1628032968"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-622"></a></pre></body></html>